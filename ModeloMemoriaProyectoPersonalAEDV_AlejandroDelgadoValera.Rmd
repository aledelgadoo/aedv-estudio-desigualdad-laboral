---
title: "Análisis de la disparidad salarial en Europa: Impacto de la estructura sectorial en España y Canarias"
author: "Alejandro Delgado Valera"
date: "`r Sys.Date()`"
output:
  html_document:
---

<!--
# TRUCOS ÚTILES AL EDITAR UN FICHERO Rmarkdown: 
(1) TECLAS: CTRL-MAY-1 : EDICIÓN DE CÓDIGO OCUPA/NO OCUPA TODA LA VENTANA
(2) TECLAS: CTRL-ALT-C : EJECUTA UN CHUNK CUANDO EL CURSOR DEL RATÓN ESTA DENTRO DEL CHUNK (OTRA FORMA ES HACER CLICK EN EL BOTÓN TRIANGULAR VERDE EN LA ESQUINA SUPERIOR DERECHA DEL CHUNK)
(3) ACTIVAR "knit on Save" PARA COMPILAR AUTOMÁTICAMENTE AL GUARDAR EL ARCHIVO (CTRL-S)
PARA CREAR UN CHUNK NUEVO USAR BOTÓN VERDE CON UNA "C" EN LA PARTE SUPERIOR DERECHA DE LA VENTANA
(4) PARA EJECUTAR UNA PORCIÓN DE CÓDIGO O VISUALIZAR EL VALOR DE UNA TABLA/VARIABLE SELECCIONAR EL CÓDIGO CON EL RATÓN Y HACER CTRL-ENTER -->

<!-- Opcionalmente, el formateo de este documento en HTML se puede mejorar usando CSS --> 

```{css, echo=F}
/* === Estilo general del documento === */
body {
font-family: "Times New Roman", serif;
font-size: 16px;
line-height: 1.6;
color: #222;
background-color: #ffffff;
margin: 40px;
}

/* === Títulos === */
h1, h2, h3, h4 {
font-family: "Times New Roman", serif;
color: #1a1a1a;
margin-top: 1.5em;
margin-bottom: 0.6em;
line-height: 1.25;
}

h1 {
font-size: 1.9em;
border-bottom: 2px solid #444;
padding-bottom: 0.2em;
}

h2 {
font-size: 1.5em;
color: #2a2a2a;
border-left: 4px solid #888;
padding-left: 0.5em;
}

h3 {
font-size: 1.25em;
color: #333;
font-style: italic;
}

/* === Párrafos y texto === */
p {
text-align: justify;
margin-bottom: 1em;
}

/* === Figuras y tablas === */
figure, .figure {
text-align: center;
margin: 1.5em auto;
}

img, .plot {
display: block;
margin: 0 auto;
max-width: 90%;
}

table {
border-collapse: collapse;
margin: 1em auto;
width: 90%;
font-size: 0.95em;
}

th, td {
border: 1px solid #ccc;
padding: 8px 12px;
text-align: center;
}

th {
background-color: #f5f5f5;
font-weight: bold;
}

/* === Pie de figuras === */
.caption {
font-size: 0.9em;
color: #555;
text-align: center;
margin-top: 0.3em;
font-style: italic;
}

/* === Código y chunks === */
pre, code {
font-family: "Courier New", monospace;
background-color: #f8f8f8;
border-radius: 4px;
padding: 2px 5px;
}

pre {
padding: 10px;
overflow-x: auto;
border: 1px solid #e0e0e0;
}

/* === Estilo para las gráficas generadas con ggplot === */
.gm-plot, .ggplot, .plotly, .html-widget svg text {
  font-family: "Times New Roman", serif !important;
  fill: #222222;
}


.leaflet, .leaflet html-widget {
    height: 480px !important;
}


/* === Márgenes de página === */
@page {
margin: 2.5cm 2cm;
}

/* --- CONTENEDOR DE CADA CHUNK --- */
.figure, .html-widget {
    display: block;
    margin-left: auto;
    margin-right: auto;
    max-width: 100%;          /* Ocupa el ancho total disponible del texto */
}

/* --- PARA FIGURAS (ggplot, png, etc.) --- */
.figure img {
    display: block;
    margin: 0 auto;
    max-width: 100%;          /* Que no se salga del ancho del texto */
    height: auto !important;  /* Mantiene proporción, no deforma */
}

/* --- PARA WIDGETS HTML (leaflet, plotly...) --- */
.html-widget {
    width: 100% !important;   /* Ocupa todo el contenedor */
}

.html-widget > div {
    width: 100% !important;
    height: auto;             /* Deja que RMarkdown/fig.height controle la altura */
}

```

```{r,echo=FALSE}
# OPCIONES POR DEFECTO AL COMPILAR LOS CHUNKS 
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  cache=F, # ponerlo a TRUE acelera la compilación pues solo recompila los chunks modificados. Es útil al escribir texto con mucho código que tarda tiempo en compilar. Puede fallar cuando unos chunks dependen de otros. En ese caso, o cuando hay errores que no entiendes, borra la carpeta auxiliar que se genera con la extensión "_cache" para obligar a recompilar todo. 
  echo=FALSE
)
```

```{r global, include=FALSE}
# carga de librerías
library(DT)
library(googlesheets4)
library(kableExtra)
library(patchwork)
library(zoo)
library(MASS)
library(flexdashboard)
library(datasets)
library(highcharter)
library(fpp3)
library(RColorBrewer)
library(openxlsx)
library(leaflet)
library(geojsonio)
library(plotly)
library(ggplot2)
library(tidyverse)
library(readr)
library(eurostat)
library(gganimate)
library(htmltools)

# Cambiar la fuente de las gráficas
theme_set(
    theme_minimal(base_family = "serif") +
    theme(
        text = element_text(family = "serif", color = "#222222"),
        plot.title = element_text(family = "serif", face = "bold", size = 16, hjust = 0.5),
        plot.subtitle = element_text(family = "serif", face = "italic", size = 14, hjust = 0.5),
        axis.title = element_text(family = "serif", face = "bold", size = 14),
        axis.text = element_text(family = "serif", size = 12),
        legend.title = element_text(family = "serif", face = "bold", size = 13),
        legend.text = element_text(family = "serif", size = 12),
        plot.margin = margin(15, 15, 15, 15),
        panel.grid.major = element_line(color = "#e0e0e0"),
        panel.grid.minor = element_blank()
    )
)

# Fuente serif también para textos dentro de los gráficos (geom_text y geom_label)
update_geom_defaults("text", list(family = "serif"))
update_geom_defaults("label", list(family = "serif"))



# asociamos funciones a determinadas librerías para evitar posibles errores 
filter <- dplyr::filter # Filtra filas según condiciones
select <- dplyr::select # Selecciona columnas
mutate <- dplyr::mutate # Crea o modifica columnas
arrange <- dplyr::arrange # Ordena filas
group_by <- dplyr::group_by # Agrupa datos
summarise <- dplyr::summarise # Resume variables (por ejemplo, con medias, conteos)
summarize <- dplyr::summarize # Lo mismo que summarise
rename <- dplyr::rename # Cambia nombres de columnas
distinct <- dplyr::distinct # Elimina filas duplicadas
slice<- dplyr::slice # Selecciona filas por posición
relocate<- dplyr::relocate # Reordena columnas

selectInput <- shiny::selectInput

# Colocamos las funciones en este mismo fichero para evitar dependencias ####

# Función de Pareto
# Dado un vector de números y un nivel de significancia de Pareto, calcula el valor del vector tal que la suma de los valores por encima de ese valor supera el total de la suma multiplicado por el nivel de significancia.

ParetoValue <- function(
        v, # vector numérico
        ParetoSignificancia # número en [0,1] con el grado de significancia de Pareto
){
    
    x <- sort(v,decreasing = TRUE)
    return(x[which(cumsum(x)>=ParetoSignificancia*sum(x))[1]])
}


#FUNCIÓN PARA DIBUJAR UNA PREDICCIÓN DINÁMICA CON USANDO plotly
GraficoDinamicoArima95CI <- function(
 data, # tssible con con los datos originales
 date, # string con el nombre se la variable temporal en data
 value, # string con el nombre se la variable numérica en data
 prediccion, # objeto con la predicción usando ARIMA u otro modelo
 TITLE # título del gráfico
){

  fc <- prediccion %>%
  mutate(lower = NA) %>%
  mutate(upper = NA)

  for(k in 1:nrow(fc)){
    fc$lower[k] <- fc$.mean[k] - 1.96*unlist(fc[[value]][k])[2]
    fc$upper[k] <- fc$.mean[k] + 1.96*unlist(fc[[value]][k])[2]
  }

  data2 <- data
  x <- data2[[date]][1]
  if(!(is.numeric(x) && !inherits(x, "Date") && !inherits(x, "POSIXt"))){
    data2[[date]] <- as.Date(data2[[date]])
    fc[[date]] <- as.Date(fc[[date]])
  }

  # A. Identificamos el último punto real
  ultimo_dato_real <- tail(data2, 1)
  val_real_final   <- ultimo_dato_real[[value]]
  fecha_real_final <- ultimo_dato_real[[date]]
  
  # B. Creamos una fila "falsa" de predicción que es idéntica al dato real
  #    Esto sirve de puente para que plotly una las líneas
  fila_ancla <- fc[1, ] # Copiamos estructura de la primera fila de predicción
  
  fila_ancla[[date]] <- fecha_real_final # Misma fecha que el último real
  fila_ancla$.mean   <- val_real_final   # El valor es el real
  fila_ancla$lower   <- val_real_final   # Límite inf = valor real (sin margen)
  fila_ancla$upper   <- val_real_final   # Límite sup = valor real (sin margen)
  
  # C. Pegamos esta fila AL PRINCIPIO de la predicción
  fc <- dplyr::bind_rows(fila_ancla, fc)


p <- plot_ly() %>%
  add_ribbons(x = fc[[date]], ymin = fc$lower, ymax = fc$upper,
              name = "95% CI", fillcolor = "rgba(0,0,150,0.2)", line = list(width = 0)) %>%
  add_lines(x=fc[[date]], y = fc$.mean, name = "Predicción", line = list(color = "blue")) %>%
  add_lines(x=data2[[date]], y = data2[[value]], name = "Observación", line = list(color = "black")) %>%
  layout(
      # Fuente Sans (Arial) y color gris oscuro (#333333)
      font = list(family = "Arial, sans-serif", color = "#333333"),
      
      # Fondo blanco puro
      paper_bgcolor = "#ffffff",
      plot_bgcolor  = "#ffffff",
      
      # Título en negrita
      title = list(
        text = paste0("<b>", TITLE, "</b>"), 
        font = list(size = 25),
        x = 0.5, 
        xanchor = "center",
        yanchor = "top"
      ),
      
      # Eje X: Cuadrícula gris suave (#dee2e6) y sin bordes negros
      xaxis = list(
        title = list(text = "<b>Año</b>", font = list(size = 17)), 
        showgrid = TRUE,
        gridcolor = "#dee2e6", 
        zeroline = FALSE,
        showline = FALSE,
        tickfont = list(color = "#555555"),
        range(100, 200)
      ),
      
      # Eje Y: Igual que el X
      yaxis = list(
        title = list(text = "<b>Valor</b>", font = list(size = 17)),
        showgrid = TRUE,
        gridcolor = "#dee2e6",
        zeroline = FALSE,
        showline = FALSE,
        tickfont = list(color = "#555555")
      ),
      
      # Leyenda 
      legend = list(
        font = list(weight = "bold", size=15),
        orientation = "v",   # Vertical
        x = 1.02,            # Justo fuera del gráfico a la derecha
        y = 1,               # Alineada arriba
        xanchor = "left",
        yanchor = "top",
        bgcolor = "rgba(0,0,0,0)"
      ),
      
      # Márgenes ajustados
      margin = list(t = 60, b = 40, l = 20, r = 160)
    )



return(p)
}

#FUNCIÓN PARA DIBUJAR UN MAPA COROPLÉTICO USANDO leaflet
MapaCoroplético <- function(
 geoj, # objeto gráfico geojson con los contornos de las regiones
 value, # vector de valores para colorear 
 region_labels, # vector de etiquetas para los desplegables
 legend_title # título de la leyenda 
){

vals <- value[!is.na(value)]

pal <- colorNumeric(
  palette = "YlOrRd",
  domain  = vals
)

p <-  geoj %>%
    leaflet() %>%  
    addProviderTiles(providers$CartoDB.VoyagerNoLabels) %>%
    setView(lng = 7, lat = 50, zoom = 4)  %>% 
    addPolygons(
        fillColor = ~pal(value),
        weight = 1,
        opacity = 1,
        color = "#555555",
        dashArray = "",
        fillOpacity = 0.75,
        highlightOptions = highlightOptions(
            weight = 3,
            color = "#333333",
            dashArray = "",
            fillOpacity = 0.8,
            bringToFront = TRUE
        ),
      label = region_labels 
    ) %>% 
    addLegend("bottomleft", 
      pal = pal, 
      values = na.omit(value),
      title = legend_title,
      labFormat = function(type, cuts, p) {
        n = length(cuts) 
        x = (cuts[-n] + cuts[-1])/2
        x = prettyNum(round(x, digits = 0), big.mark = " ")
        as.character(x)
      },
 
      opacity = 1
      )
  return(p)
}

MapaCoropléticoES <- function(
 geoj, # objeto gráfico geojson con los contornos de las regiones
 value, # vector de valores para colorear 
 region_labels, # vector de etiquetas para los desplegables
 legend_title # título de la leyenda 
){
vals <- value[!is.na(value)]

pal <- colorNumeric(
  palette = "YlOrRd",
  domain  = vals
)

p <-  geoj %>%
    leaflet() %>%  
    addProviderTiles(providers$CartoDB.VoyagerNoLabels) %>%
    setView(lng = -7, lat = 35.8, zoom = 5)  %>% 
    addPolygons(
        fillColor = ~pal(value),
        weight = 1,
        opacity = 1,
        color = "#555555",
        dashArray = "",
        fillOpacity = 0.75,
        highlightOptions = highlightOptions(
            weight = 3,
            color = "#333333",
            dashArray = "",
            fillOpacity = 0.8,
            bringToFront = TRUE
        ),
      label = region_labels 
    ) %>% 
    addLegend("topleft", 
      pal = pal, 
      values = na.omit(value),
      title = legend_title,
      labFormat = function(type, cuts, p) {
        n = length(cuts) 
        x = (cuts[-n] + cuts[-1])/2
        x = prettyNum(round(x, digits = 0), big.mark = " ")
        as.character(x)
      },
 
      opacity = 1
      )
  return(p)
}



# CÁLCULO DE LA TRANSFORMACIÓN DE YEO–JOHNSON A PARTIR DE UN VECTOR Y UN VALOR DE lambda 
yeo.johnson <- function(y, lambda) {
  y_t <- numeric(length(y))
  
  # Para y >= 0
  pos_idx <- which(y >= 0)
  if (lambda == 0) {
    y_t[pos_idx] <- log(y[pos_idx] + 1)
  } else {
    y_t[pos_idx] <- ((y[pos_idx] + 1)^lambda - 1) / lambda
  }
  
  # Para y < 0
  neg_idx <- which(y < 0)
  if (lambda == 2) {
    y_t[neg_idx] <- -log(-y[neg_idx] + 1)
  } else {
    y_t[neg_idx] <- -(((-y[neg_idx] + 1)^(2 - lambda) - 1) / (2 - lambda))
  }
  
  return(y_t)
}


# ESTIMACIÓN DE lambda PARA LA TRANSFORMACIÓN DE YEO–JOHNSON DE UN VECTOR y
# OPTIMIZANDO  EL R2 DE LA REGRESIÓN LINEAL CON UN VECTOR x.  
optimize.yeojohnson.R2 <- function(x, y, lambda_range = c(-1, 1.9)) {
 
  # Función objetivo: R² negativo (porque optimize minimiza)
  r2_neg <- function(lambda) {
    y_t <- yeo.johnson(y, lambda)
    modelo <- lm(y_t ~ x)
    return(-summary(modelo)$r.squared)  # queremos maximizar R²
  }
  
  # Optimización de lambda
  opt <- optimize(r2_neg, interval = lambda_range)
  
  # Se retorna el valor óptimo de lambda 
  return(opt$minimum)
}

# FUNCIÓN PARA DIBUJAR LA MATRIZ DE CORRELACIÓN
plot_correlation <- function(
M, # matriz de correlación
show_values = TRUE # flat para controlar si se imprimen los valores en las celdas
) {
  
  # Texto dentro de la celda (2 decimales)
  cell_text <- round(M, 2)
  
  # Escala personalizada: rojo -> blanco -> azul
  custom_colors <- list(
    c(0, "red"),    # mínimo (-1) → azul
    c(0.5, "white"),# 0 → blanco
    c(1, "steelblue")    # máximo (+1) → rojo
  )
  
  # Crear heatmap interactivo
  plot_ly(
    x = colnames(M),
    y = rownames(M),
    z = M,
    type = "heatmap",
    colorscale = custom_colors,
    zmin = -1,
    zmax = 1,
    text = if (show_values) cell_text else NULL,
    texttemplate = if (show_values) "%{text}" else NULL,
    textfont = list(color = "black"),
    hovertemplate = "X: %{x}<br>Y: %{y}<br>Correlación: %{z:.4f}<extra></extra>"
  ) %>%
    layout(
      title = "Matriz de correlación interactiva",
      xaxis = list(title = "", tickangle = 45),
      yaxis = list(title = "", autorange = "reversed")
    )
}
```

<!-- Todos los proyectos personales tienen que tener un cuadro de mandos (Tema 7 de la asignatura) cuya dirección es similar a la que sigue poniendo tu nº de usuario (en lugar de a2405) y el nombre del Rmd asociado. Los cuadros de mando se alojan en un servidor del DIS y solo se puede acceder a ellos a través de la red de la ULPGC o usando VPN -->

[Cuadro de mandos](http://10.22.143.222:3838/sample-apps/a2613/DashboardProyectoPersonalAEDV_AlejandroDelgadoValera.Rmd)  
[Enlace al repositorio en GitHub](https://github.com/aledelgadoo/ProyectoPersonal_AEDV)


<!-- Añadir imagen ilustrativa del tema de mi proyecto --> 
<center>
<img src="images/portada.jpg" width="60%" />
</center>

# Introducción
<!-- situar el tema en un contexto amplio, destacando su relevancia en la actualidad. Delimitar el problema que se aborda en ese contexto amplio --> 
La economía europea se construyó sobre la promesa de la convergencia: la idea de que, con el tiempo y la integración de mercados, los niveles de vida y la riqueza de los estados miembros tenderían a igualarse. Sin embargo, tres décadas después, la realidad dibuja un mapa de velocidades divergentes. En este escenario, España, y muy particularmente la región de Canarias, se enfrenta a una paradoja persistente: a pesar de los esfuerzos de modernización y la integración en el mercado común, la brecha salarial con el núcleo económico europeo no solo no se cierra, sino que en muchos aspectos amenaza con cronificarse.  

La narrativa popular, y a menudo política, ha tendido a simplificar este fenómeno atribuyéndolo a factores culturales o individuales, sugiriendo que la baja remuneración en el sur de Europa es consecuencia de una menor "cultura del esfuerzo" o de una ineficiencia intrínseca del trabajador. Este proyecto nace para desafiar esa noción mediante el análisis riguroso de los datos.  

La presente memoria aborda esta problemática desde una perspectiva de *Análisis Exploratorio de Datos y Visualización (AEDV)*, desentrañando la relación entre el coste laboral, las horas trabajadas y la estructura sectorial. El trabajo plantea que el determinante del salario no es la geografía ni el esfuerzo individual, sino la especialización productiva. A través de un viaje analítico que va de lo macro (Europa) a lo micro (Canarias), se busca demostrar que la estructura económica actúa como un "techo de cristal" que limita la generación de valor, independientemente de la intensidad del trabajo realizado.  

##  Estado actual
<!-- Explicar conceptos claves relacionados con el tema que se aborda. Comentar estudios/resultados precedentes. Identificación de elementos/circunstancias que justifican la realización del estudio sobre este tema. Relevancia y oportunidad de abordar el tema.-->
La discusión económica sobre la disparidad de riqueza en Europa se fundamenta en este estudio a través de la relación entre dos variables críticas: las Horas Trabajadas (como medida del volumen de esfuerzo o intensidad laboral) y el Coste Laboral (como indicador de la valoración de mercado de dicho esfuerzo).  

Históricamente, la literatura ha señalado una divergencia estructural entre el "Norte" y el "Sur" del continente. Mientras que las economías centrales han evolucionado hacia modelos donde se maximiza el valor por hora, permitiendo altos salarios sin aumentar la carga lectiva, los estudios precedentes sobre la economía española sugieren la persistencia de un modelo de crecimiento extensivo. Esto implica una dinámica económica basada en la acumulación de factor trabajo (más empleo, jornadas más largas y mayor presencialismo) que, paradójicamente, no logra traducirse en un aumento proporcional del valor unitario, manteniendo los costes laborales estancados en comparación con los estándares europeos. 

Esta dinámica se ha visto agravada por dos hitos recientes que justifican la oportunidad de este análisis:  

- **Las secuelas de la crisis financiera (2008-2014)**: Que provocaron una devaluación salarial interna en España como mecanismo para recuperar competitividad.

- **El shock asimétrico del COVID-19 (2020)**: Que distorsionó las estadísticas de costes laborales al reducir drásticamente las horas trabajadas mientras se sostenían las rentas mediante mecanismos públicos (ERTEs), generando un "falso positivo" de productividad en los datos que requiere ser depurado y analizado.

La importancia de este estudio es máxima en el momento actual, donde el coste de la vida no para de subir. Necesitamos entender por qué los sueldos en Canarias son bajos: ¿es porque producimos poco o porque nuestra economía está enfocada en los sectores equivocados? La justificación es clara: hace falta comprobar con datos si depender tanto del turismo y los servicios básicos actúa como un freno que nos impide alcanzar el nivel de riqueza del resto de Europa.  

## Motivación
<!-- Descripción de la motivación que te ha llevado a elegir este tema de trabajo que puede incluir intereses personales/sociales/profesionales --> 
Aunque este proyecto nace en el contexto académico de la asignatura de Análisis Exploratorio de Datos y Visualización (AEDV), la elección de estos datasets responde a una inquietud vital como estudiante del Grado en Ciencia e Ingeniería de Datos.  

La motivación principal es confrontar con datos una realidad que condiciona mi futuro inmediato: la narrativa generalizada de que, para prosperar en el sector tecnológico, es obligatorio emigrar a la península o al resto de Europa. He elegido analizar los costes laborales y la estructura sectorial para verificar empíricamente si esa "sentencia" es real. Necesito entender si la devaluación salarial en Canarias afecta también a perfiles de alta cualificación como el mío, o si es un problema exclusivo de otros sectores. En definitiva, este trabajo es una auditoría personal para descubrir si la estructura económica de las islas penaliza mi talento y me empuja inevitablemente a hacer las maletas.

## Objetivos
<!-- Expresa de forma amplia y global el propósito principal del trabajo. Cuales son sus metas principales -->
El propósito principal de este trabajo es determinar, mediante un análisis de datos cuantitativo y visual, las causas estructurales de la baja remuneración en España y Canarias. Se busca demostrar la hipótesis de que la brecha salarial no es consecuencia de una menor intensidad laboral (horas trabajadas), sino de una especialización productiva en sectores de bajo valor añadido que limita estructuralmente la generación de riqueza.  

Para alcanzar esta meta global, se plantean los siguientes objetivos específicos:  

1. **Analizar la eficiencia a escala europea:** Establecer la correlación entre coste laboral y horas trabajadas en la UE-27 para validar si existe una relación inversa entre presencialismo y productividad.  

2. **Evaluar la evolución temporal en España:** Examinar la trayectoria de los costes y horas desde el año 2000 para identificar el impacto de las crisis y verificar si existe convergencia o divergencia con los estándares europeos.  

3. **Mapear la desigualdad regional:** Visualizar la distribución geográfica de la riqueza y el esfuerzo en España para identificar patrones territoriales y aislar el comportamiento de las Comunidades Autónomas.  

4. **Identificar el determinante sectorial:** Desglosar el coste laboral por sectores económicos para demostrar cómo la composición del tejido productivo (p. ej. peso de la hostelería vs. servicios profesionales) condiciona el techo salarial de cada región.  

5. **Diagnosticar la brecha de Canarias:** Cuantificar la diferencia salarial específica del archipiélago respecto a la media nacional y determinar en qué sectores se produce el mayor "desacople" de valor.  

# Aportaciones del trabajo

<!-- estas sección se suele escribir al final del trabajo --> 

## Principales aportaciones
<!-- Análisis del significado e implicaciones de los resultados en el contexto del área de estudio. Nuevas perspectivas o enfoques. Actualización del conocimiento existente. Debe estar alineado con los objetivos. Comentar cuadro de mandos como aportación  -->
Este trabajo aporta una revisión crítica y basada en datos de la narrativa económica tradicional sobre la desigualdad regional en España. Más allá de la limpieza y tratamiento dels dataset, las principales contribuciones al área de estudio son:  

1. **Refutación del mito "Horas vs. Riqueza":** El estudio demuestra una correlación inversa entre esfuerzo y salario, aportando una nueva perspectiva: la baja renta en Canarias no se debe a la falta de intensidad laboral (presencialismo), sino a la baja capacidad estructural del modelo para generar valor.  

2. **Diagnóstico de la "Penalización Insular del Talento":** Se actualiza el conocimiento sobre la brecha salarial al revelar que afecta desproporcionadamente a los sectores de alta cualificación. Un profesional científico/tecnológico sufre mayor depreciación salarial en las islas que un trabajador de servicios, evidenciando una barrera estructural que incentiva la *fuga de cerebros*.  

3. **Evidencia de Desacople Económico:** Los análisis temporales contradicen las teorías de convergencia, mostrando que la brecha Canarias-España se ha ensanchado tras las crisis de 2008 y 2020.  

4. **Cuadro de Mandos (Dashboard) como herramienta:** La principal aportación técnica es la transformación de datos dispersos (Eurostat/INE) en un Dashboard Interactivo. Esta herramienta permite superar el análisis estático, facilitando la exploración dinámica de las tendencias y democratizando el acceso a información económica compleja.  


## Alineamiento con los objetivos de desarrollo sostenible
<!-- Hay que rellenar el fichero "ODS.xlsx" con nuestros datos. Si en ChatGPT hacemos la consulta "Relacionar "mi tema de proyecto" con ODS" nos saldrá un borrador de relaciones que podremos usar como base y  perfeccionar. --> 

Este proyecto no se queda solo en el análisis teórico, sino que conecta directamente con los problemas reales que la Agenda 2030 de la ONU busca resolver. Al usar datos para entender por qué existen estas desigualdades y por qué los salarios son bajos en Canarias, el trabajo aporta información útil para mejorar nuestra sociedad. A continuación, se muestra cómo se relaciona el estudio con cada objetivo:

```{r ods}
tb <- read.xlsx("data/ODS.xlsx") %>%
  as_tibble()
tb[is.na(tb)] <- ""

colnames(tb) <- c("ODS","No procede", "Bajo", "Medio","Alto")
tabla <- kable(tb,caption="Grado de relación del proyecto con los objetivos de desarrollo sostenible (ODS)", 
                format = "html",
                table.attr = 'style="width:500px; margin-left: auto; margin-right: auto;"',
                booktabs = FALSE,        # <— desactiva el estilo "limpio" sin líneas
                linesep = "") %>%            # <— evita espacios innecesarios entre filas) 
    
        kable_styling(
        bootstrap_options = c("striped", "bordered", "condensed"), # añade bordes
        full_width = FALSE,
        position = "center")
                
tabla %>% column_spec(2, extra_css = "text-align: center;") %>%
          column_spec(3, extra_css = "text-align: center;") %>%
          column_spec(4, extra_css = "text-align: center;") %>%
          column_spec(5, extra_css = "text-align: center;")
```

# Desarrollo


## Herramientas empleadas
<!-- mencionar y justificar para este trabajo el uso de R, RStudio y las librerías principales utilizadas. Mencionar también el servidor shiny del DIS para desplegar públicamente el cuadro de mandos    --> 
El desarrollo técnico de este proyecto se fundamenta en el lenguaje *R* y el entorno *RStudio*. Esta plataforma ofrece grandes ventajas para el Análisis Exploratorio de Datos gracias a su potencia estadística y su capacidad nativa para el tratamiento de datos. Además, el uso de *R Markdown (.Rmd)* ha sido clave para integrar código, análisis y narrativa en un único flujo de trabajo, generando como resultado final una memoria en formato HTML totalmente reproducible.  

Para la ejecución del proyecto, se han empleado las siguientes librerías:  

- **Manipulación y Preparación de Datos**: El procesamiento se ha centralizado en el ecosistema `tidyverse`. La librería `dplyr` ha sido el motor principal para limpiar, transformar y calcular métricas complejas (como brechas salariales y costes sectoriales), apoyada en `readr` y `eurostat` para la ingesta eficiente de los datos brutos.  

- **Visualización y Narrativa Visual**: Para construir la historia visual se ha combinado la gramática de `ggplot2` con librerías de interactividad:  

    - `plotly` y `highcharter`: Para convertir gráficos estáticos en visualizaciones dinámicas (zoom, tooltips) que facilitan la exploración.  

    - `leaflet` y `geojsonio`: Para la creación de los mapas coropléticos interactivos (Actos I y III).  

    - `gganimate`: Para visualizar la evolución temporal de la eficiencia y los costes (Acto I).  

- **Despliegue y Dashboarding**: La presentación final se estructura mediante `flexdashboard` y `shinydashboard`, creando un cuadro de mandos profesional y reactivo. Para su despliegue público, el archivo se aloja en el servidor Shiny del *Departamento de Ingeniería de Sistemas (DIS)* de la universidad, permitiendo su ejecución remota vía web sin necesidad de instalación local.

- **Control de Versiones**: Finalmente, para garantizar la integridad del código y facilitar el desarrollo iterativo, se ha utilizado *Git* junto con *GitHub* como repositorio remoto. Esto no solo ha servido para el control de versiones, sino para dar visibilidad pública al código fuente del proyecto una vez finalizado.

## Metodología

Utilizaremos la metodología de desarrollo *CRISP-DM* (Cross Industry Standard Process for Data Mining) que es un marco ampliamente utilizado para proyectos de Ciencias de Datos. En la siguiente figura se presenta un diagrama con las diferentes fases de esta metodología que a continuación describimos con más detalle: 

<center>
<img src="https://ctim.es/AEDV/1200px-CRISP-DM_Process_Diagram1.5x.png" width="40%" />
<p style="font-size: 14px; color: gray;"><em>Diagrama metodología de desarrollo CRISP-DM</em></p>
</center>



* **Comprensión del negocio**. Se plantean los objetivos del proyecto y la búsqueda de información y datos. 

<!-- Una parte de esta fase incluye la descripción del objeto del proyecto y sus objetivos, como eso ya se ha presentado anteriormente en la memoria no se repite aquí. Otra parte que si se incluye es describir lo que se ha hecho para  la búsqueda de datos, las fuentes consultadas, entrevistas, lecturas bibliográficas, etc.. señalando las incidencias/dificultades encontradas, así como el análisis de la fiabilidad de la información obtenida. En esta fase no se realiza una descripción detallada de los datos ni pondremos gráficas.  -->


* **Comprensión de los datos**. Se analiza la  estructura y organización de los datos obtenidos. Se identifican posible problemas como datos faltantes, outliers o inconsistencias. 

<!-- Identificar y describir con claridad el significado de las variables categóricas existentes (y todos los valores que pueden tomar) y las observaciones (habitualmente valores numéricos). Identificar si los datos están organizados de forma ordenada (tidy), es decir una sola observación por cada fila de la tabla acompañada de variables categóricas o de forma no ordenada, es decir, varias observaciones por cada fila. En este caso,  habitualmente, los valores posibles de una variable categórica se distribuyen como títulos de columnas de la tabla y cada celda de esas columnas incluye una observación. Estudiar la frecuencia (Nº de observaciones) asociadas a las variables categóricas, el tamaño e intervalo temporal de las series temporales (si procede), la distribución del nº de observaciones por regiones, o por otro tipo de desglose de la información (si procede), análisis de los atributos combinados existentes, dados por las combinaciones de variables categóricas que aparecen en el dataset. Analizar en más detalle (si hubiera lugar) como son los datos en la regiones que más me interesan. Identificación de errores, valores ausentes, outliers o cualquier otra incosistencia encontrada. 

En esta fase no se realiza procesado de datos salvo el mínimo para obtener la información que se requiere. Tampoco se entra a valorar la calidad de los datos o como habría que procesarlos. En términos médicos, esta sería la fase del diagnóstico donde todavía no se comenta nada del pronóstico del paciente o del tratamiento. Por tanto no se expresan opiniones sobre los datos, solo se exponen tal cual son. 

En esta fase, en general, no pondremos gráficos, salvo cosas muy sencillas relativas a las frecuencias de los datos y cosas de ese tipo, pues los gráficos requieren, en general, selección y procesamiento de datos previo. 

El análisis de los datos realizado para la validación del tema del proyecto personal va en este apartado. 

--> 
 
* **Preparación de los datos**. Se realiza limpieza, transformación, combinación y selección/creación de variables relevantes para el análisis

<!-- En esta fase, a partir de los resultados de la fase anterior, estudiamos la relevancia y calidad de la información obtenida en la fase anterior de acuerdo con los objetivos del proyecto, si procede seleccionamos/eliminamos variables categóricas o algunas de sus opciones, exponiendo con claridad y justificadamente los atributos combinados (formados por combinaciones de variables categóricas) que vamos a usar en el estudio. Decidimos el intervalo temporal que vamos a usar para  nuestro estudio. Realizamos la limpieza, transformación,  creación de nuevas variables, combinación de tablas,etc... En esta fase pondremos las gráficas que ilustran los datos una vez procesados y seleccionados pero sin usar los modelos que se formulan en la siguiente fase.  --> 

* **Modelado**. Selección y aplicación de los modelos adecuados para analizar los datos 

<!-- Se aplican a los datos los modelos utilizados, como por ejemplo, regresión lineal, modelos ARIMA, matriz de correlación, PCA, etc.. En esta fase se pondrán gráficas sobre el uso de de estos modelos.  --> 

* **Evaluación**. Evaluar si el modelo responde a las preguntas de investigación, comparación con otros métodos 

<!-- Se discuten de forma crítica los resultados obtenidos incluyendo pruebas de evaluación / validación realizadas (si procede) --> 

* **Despliegue**. Comunicación del trabajo en una memoria y diseño y elaboración de un cuadro de mandos para presentar los resultados de forma eficaz y atractiva. 

<!-- El despliegue de este proyecto se realizará a través de la confección de esta memoria y de un cuadro de mandos. --> 

 
 <!-- De acuerdo con esta metodología, los resultados se van presentando, discutiendo y validando a lo largo de las fases de **Modelado**, **Evaluación** y **Despliegue** y, por tanto, para mantener una estructura coherente de la memoria, de acuerdo con la aplicación de la  metodología CRISP-DM, no existe en la memoria una sección separada de presentación de resultados.  --> 
 
 
 Es importante observar que esta metodología es iterativa, es decir que los resultados obtenidos en algunas de las fases puede afectar al desarrollo de fases anteriores. 
 
 A continuación se describirá en detalle como se han abordado cada una de las fases del desarrollo del proyecto siguiendo esta metodología.


## Comprensión del negocio
<!-- desarrollo de esta fase -->

Para garantizar la idoneidad de los datos respecto a los objetivos de la asignatura y la capacidad de cómputo disponible, se estableció un protocolo de búsqueda y selección estructurado en tres fases:  

#### Fase 1: Filtrado Cuantitativo y Dimensional  
Partiendo del repositorio de fuentes oficiales proporcionado por la docencia, se aplicó un primer filtro basado en requisitos técnicos y dimensionales. Se priorizaron conjuntos de datos con una extensión temporal significativa (series temporales largas) y un volumen de observaciones manejable pero suficiente para el análisis profundo (rango objetivo entre 10 mil y 10 mill. registros). Este criterio aseguró un equilibrio entre la riqueza de información y la viabilidad del procesamiento computacional.

#### Fase 2: Evaluación Temática y Potencial Analítico  
Sobre los datasets resultantes, se realizó una exploración cualitativa asistida por herramientas de Inteligencia Artificial para analizar rápidamente los metadatos y descripciones. El objetivo fue identificar temáticas con alto potencial narrativo y relevancia socioeconómica. Se cruzaron las características de los candidatos con los contenidos teóricos del manual de la asignatura, buscando variables que permitieran aplicar las técnicas de visualización avanzadas (mapas, series temporales, comparativas categóricas) exigidas en el proyecto.

#### Fase 3: Validación Normativa y Selección Definitiva  
Tras la preselección de un primer candidato y su posterior descarte por no ajustarse estrictamente a la totalidad de los requisitos de la rúbrica (específicamente en la granularidad de las variables), se procedió a la elección final del dataset `nama_10r_2lp10`. Este conjunto de datos superó la validación final al cumplir con todos los criterios: estructura tidy, presencia de variables categóricas y numéricas, desglose geográfico (NUTS 2) y una serie temporal completa (1995-2023), permitiendo el análisis multinivel (Europa-España-Canarias) propuesto.

## Comprensión de los datos
<!-- desarrollo de esta fase -->

### Información general del dataset
```{r, echo=F}
# LEER EL DATASET QUE HEMOS ALMACENADO EN MEMORIA
dataset.name <- "nama_10r_2lp10"

dataset.original <- read_csv(paste0("data/", dataset.name, ".csv")) %>%
  as_tibble()

dataset.info <- read_csv(paste0("data/", dataset.name, "_info.csv")) %>% 
    as_tibble()

data <- dataset.original %>% 
    arrange(TIME_PERIOD,geo)
```

- **code**: `r dataset.info$code[1]`
- **title**: `r dataset.info$title[1]`
- **last.update.of.data**: `r dataset.info$last.update.of.data[1]`
- **last.table.structure.change**: `r dataset.info$last.table.structure.change[1]`
- **data.start**: `r dataset.info$data.start[1]`
- **data.end**: `r dataset.info$data.end[1]`
- **values**: `r format(dataset.info$values[1],big.mark = ".")`

### Explicación de variables categóricas

Los datos de nuestro dataset están organizados de forma tidy. Los variables categóricas que existen, su significado, y sus valores posibles son:

- **freq**: Frecuencia con la que se toman las observaciones. Tiene un único valor "A", que corresponde a datos anuales.

- **nace_r2**: Rama de actividad económica. Se divide según la clasificación NACE Rev. 2. *Los códigos pueden corresponder a una sección concreta (ej. A, C, F), a un rango de secciones consecutivas indicado con guion (ej. B-E, G-I), o a agrupaciones específicas de varias secciones señaladas con guion bajo (ej. M_N).*  
Valores posibles: 
  - TOTAL: Total - todas las actividades NACE  
  - O-U: Administración pública y defensa; actividades de computación obligatoria; educación; salud humana y servicios sociales; artes, entretenimiento y otros servicios  
  - O-Q: Administración pública, defensa, educación, actividades sanitarias y de servicios sociales  
  - B-E: Industria (excepto construcción)  
  - K-N: Actividades financieras y de seguros; inmobiliarias; profesionales, científicas y técnicas; servicios administrativos 
  - F: Construcción  
  - M_N: Actividades profesionales, científicas y técnicas; actividades administrativas y servicios auxiliares
  - A: Agricultura, silvicultura y pesca  
  - C: Industria manufacturera  
  - G-J: Comercio mayorista y minorista; transporte; alojamiento; información y comunicación  
  - R-U: Artes, entretenimiento y recreación; otros servicios  
  - G-I: Comercio mayorista y minorista; transporte; alojamiento y servicios de comida  
  - J: Información y comunicaciones  
  - K: Actividades financieras y de seguros  
  - L: Actividades inmobiliarias  
<br>

- **na_item**: Tipo de indicador económico relacionado con los costes laborales y las horas trabajadas.  

  - D1_SAL_HW: Coste laboral por hora trabajada, que incluye sueldos, salarios y cotizaciones sociales pagadas por el empleador (*euros por hora*).  
  - D1_SAL_PER: Coste laboral medio por persona empleada, considerando tanto la remuneración directa como las contribuciones sociales a cargo de la empresa (*euros por empleado*).  
  - HW_EMP: Horas efectivamente trabajadas por persona empleada en promedio, es decir, el total de horas dedicadas al trabajo dividido entre el número de empleados (*horas por empleado*).  
<br> 

- **unit**: Unidad de medida de los valores registrados para cada indicador.  

  - EUR: Euro  
  - NAC: Moneda nacional  
  - PC_EU27_2020_MEUR_CP: Porcentaje del total de la UE27 (desde 2020) en precios corrientes  
  - HW: Horas trabajadas  
  - PCH_PRE: Variación porcentual respecto al periodo anterior  
<br>

- **geo**: Regiones para las que existen observaciones.

  - NUTS 0: 29 países  
  - NUTS 1: 95 regiones  
  - NUTS 2: 249 comunidades  
  - EU27_2020: promedio de la Unión Europea compuesto por los 27 países miembros vigentes desde el año 2020    
  - OTHERS: 20 códigos que no corresponden a regiones reales  
<br>
  
- **TIME_PERIOD**: Fechas de las observaciones. Comprende datos desde 1995 hasta 2023, con observaciones anuales. La cantidad de registros por año varía, siendo especialmente elevada entre 2000 y 2021, destacando los años 2016 y 2020 como los que concentran más observaciones. Cabe destacar que en 2023 el número de registros disminuye significativamente respecto a años anteriores.  

```{r}
# CÓDIGOS NUTS DE REGIONES REALES PRESENTES EN LOS MAPAS NUTS ACTUALES

NUTS0_codes <- c("EL", "ES", "FI", "FR", "HR", "HU", "IE", "IS", "AL", "AT", "BA", "BE", "BG", "CH", "CY", "CZ", "DE", "DK", "EE", "IT", "LI", "LT", "LU", "LV", "ME", "MK", "MT", "NL", "NO", "PL", "PT", "RO", "RS", "SE", "SI", "SK", "TR", "UA", "XK")

NUTS1_codes <- c("DEA", "DEB", "DEC", "DED", "DEE", "DEF", "DEG", "DK0", "EE0", "EL3", "EL4", "EL5", "EL6", "ES1", "ES2", "ES3", "ES4", "ES5", "ES6", "ES7", "FI1", "AL0", "AT1", "AT2", "AT3", "BA0", "BE1", "BE2", "BE3", "BG3", "BG4", "CH0", "CY0", "CZ0", "DE1", "DE2", "DE3", "DE4", "DE5", "DE6", "DE7", "DE8", "DE9", "HR0", "HU1", "HU2", "HU3", "IE0", "IS0", "ITC", "ITF", "ITG", "ITH", "ITI", "LI0", "XK0", "LT0", "LU0", "LV0", "ME0", "MK0", "MT0", "NL1", "NL2", "NL3", "NL4", "NO0", "PL2", "PL4", "PL5", "PL6", "PL7", "PL8", "PL9", "PT1", "PT2", "PT3", "RO1", "RO2", "RO3", "RO4", "RS1", "RS2", "SE1", "SE2", "SE3", "SI0", "SK0", "TR1", "TR2", "TR3", "TR4", "TR5", "TR6", "TR7", "TR8", "TR9", "TRA", "TRB", "TRC", "FI2", "FR1", "FRB", "FRC", "FRD", "FRE", "FRF", "FRG", "FRH", "FRI", "FRJ", "FRK", "FRL", "FRM", "FRY")

NUTS2_codes <- c("DE12", "DE13", "DE14", "DE21", "DE22", "DE23", "DE24", "DE25", "DE26", "DE27", "DE30", "DE40", "DE50", "DE60", "DE71", "DE72", "DE73", "DE80", "DE91", "DE92", "DE93", "DE94", "DEA1", "DEA2", "DEA3", "DEA4", "DEA5", "DEB1", "DEB2", "DEB3", "DEC0", "DED2", "DED4", "DED5", "DEE0", "DEF0", "DEG0", "DK01", "AL01", "AL02", "AL03", "AT11", "AT12", "AT13", "AT21", "AT22", "AT31", "AT32", "AT33", "AT34", "BA01", "BA02", "BA03", "BE10", "BE21","BE22", "BE23", "BE24", "BE25", "BE31", "BE32", "BE33", "BE34", "BE35", "BG31", "BG32", "BG33", "BG34", "BG41", "BG42", "CH01", "CH02", "CH03", "CH04", "CH05", "CH06", "CH07", "CY00", "CZ01", "CZ02", "CZ03", "CZ04", "CZ05", "CZ06", "CZ07", "CZ08", "DE11", "MK00", "MT00", "NL11", "NL12", "NL13", "NL21", "NL22", "NL23", "NL32", "NL34", "NL35", "NL36", "NL41", "NL42", "NO02", "NO06", "NO07", "NO08", "NO09", "NO0A", "NO0B", "PL21", "PL22", "PL41", "PL42", "PL43", "PL51", "PL52", "PL61", "PL62", "PL63", "PL71", "PL72", "PL81", "PL82", "PL84", "PL91", "PL92", "PT11", "PT15", "PT19", "PT1A", "PT1B", "PT1C", "DK02", "DK03", "DK04", "DK05", "EE00", "EL30", "EL41", "EL42", "EL43", "EL51", "EL52", "EL53", "EL54", "EL61", "EL62", "EL63", "EL64", "EL65", "ES11", "ES12", "ES13", "ES21", "ES22", "ES23", "ES24", "ES30", "ES41", "ES42", "ES43", "ES51", "ES52", "ES53", "ES61", "ES62", "ES63", "ES64", "ES70", "FI19", "FI1B", "FI1C", "FI1D", "FI20", "FR10", "FRB0", "FRC1", "FRC2", "FRD1", "FRD2", "FRE1", "FRE2", "FRF1", "FRF2", "FRF3", "FRG0", "FRH0", "FRI1", "FRI2", "FRI3", "FRJ1", "FRJ2", "FRK1", "FRK2", "FRL0", "FRM0", "FRY1", "FRY2", "FRY3", "FRY4", "FRY5", "HR02", "HR03", "HR05", "HR06", "HU11", "HU12", "HU21", "HU22", "HU23", "HU31", "HU32", "HU33", "IE04", "IE05", "IE06", "IS00", "ITC1", "ITC2", "ITC3", "ITC4", "ITF1", "ITF2", "ITF3", "ITF4", "ITF5", "ITF6", "ITG1", "ITG2", "ITH1", "ITH2", "ITH3", "ITH4", "ITH5", "ITI1", "ITI2", "ITI3", "ITI4", "LI00", "LT01", "LT02", "LU00", "LV00", "ME00", "SE33", "SI03", "SI04", "SK01", "SK02", "SK03", "SK04", "TR10", "TR21", "TR22", "TR31", "TR32", "TR33", "TR41", "TR42", "TR51", "TR52", "TR61", "TR62", "TR63", "TR71", "TR72", "TR81", "TR82", "TR83", "TR90", "TRA1", "TRA2", "TRB1", "TRB2", "TRC1", "TRC2", "TRC3", "XK00", "PT1D", "PT20", "PT30", "RO11", "RO12", "RO21", "RO22", "RO31", "RO32", "RO41", "RO42", "RS11", "RS12", "RS21", "RS22", "SE11", "SE12", "SE21", "SE22", "SE23", "SE31", "SE32")

NUTS3_codes <- c("AT333", "AT334", "AT335", "AT341", "AT342", "BE100", "BE211", "BE212", "BE213", "BE223", "BE224", "BE225", "BE231", "BE232", "BE233", "BE234", "BE235", "BE236", "BE241", "BE242", "BE251", "BE252", "BE253", "BE254", "BE255", "BE256", "BE257", "BE258", "BE310", "BE323", "BE328","BE329", "BE32A", "BE32B", "BE32C", "BE32D", "BE331", "BE332", "BE334", "BE335", "BE336", "BE341", "BE342", "BE343", "BE344", "BE345", "BE351", "BE352", "BE353", "BG311", "BG312", "BG313", "BG314", "BG315", "BG321", "BG322", "BG323", "BG324", "BG325", "BG331", "BG332", "BG333", "BG334", "BG341", "BG342", "BG343", "BG344", "BG411", "BG412", "BG413", "BG414", "BG415", "BG421", "BG422", "BG423", "BG424", "BG425", "CH011", "CH012", "CH013", "CH021", "CH022", "CH023", "CH024", "CH025", "CH031", "CH032", "CH033", "CH040", "CH051", "CH052", "CH053", "CH054", "CH055", "CH056", "CH057", "CH061", "CH062", "CH063", "CH064", "CH065", "CH066", "CH070", "CY000", "CZ010", "CZ020", "CZ031", "CZ032", "CZ041", "CZ042", "CZ051", "CZ052", "CZ053", "CZ063", "CZ064", "CZ071", "CZ072", "CZ080", "DE111", "DE112", "DE113", "DE114", "DE115", "DE116", "DE117", "DE118", "DE119", "DE11A", "DE11B", "DE11C", "DE11D", "DE121", "DE122", "DE123", "DE124", "DE125", "DE126", "DE127", "DE128", "DE129", "DE12A", "DE12B", "DE12C", "DE131", "DE132", "DE133", "DE134", "DE135", "DE136", "DE137", "DE138", "DE139", "DE13A", "DE141", "DE142", "DE143", "DE144", "DE145", "DE146", "DE147", "DE148", "DE149", "DE211", "DE212", "AL011", "AL012", "AL013", "AL014", "AL015", "AL021", "AL022", "AL031", "AL032", "AL033", "AL034", "AL035", "AT111", "AT112", "AT113", "AT121", "AT122", "AT123", "AT124", "AT125", "AT126", "AT127", "AT130", "AT211", "AT212", "AT213", "AT221", "AT222", "AT223", "AT224", "AT225", "AT226", "AT311", "AT312", "AT313", "AT314", "AT315", "AT321", "AT322", "AT323", "AT331", "AT332", "DE238", "DE239")

NUTS3_codes <-c(NUTS3_codes, "DE23A", "DE241", "DE242", "DE243", "DE244", "DE245", "DE246", "DE247", "DE248", "DE249", "DE24A", "DE24B", "DE24C", "DE24D", "DE251", "DE252", "DE253", "DE254", "DE255", "DE256", "DE257", "DE258", "DE259", "DE25A", "DE25B", "DE25C", "DE261", "DE262", "DE263", "DE264", "DE265", "DE266", "DE267", "DE268", "DE269", "DE26A", "DE26B", "DEA5C", "DEB11", "DEB12", "DEB13", "DEB14", "DEB15", "DEB17", "DEB18", "DEB1A", "DEB1B", "DEB1C", "DEB1D", "DEB21", "DEB22", "DEB23", "DEB24", "DEB25", "DEB31", "DEB32", "DEB33", "DEB34", "DEB35", "DEB36", "DEB37", "DEB38", "DEB39", "DEB3A", "DEB3B", "DEB3C", "DEB3D", "DEB3E", "DEB3F", "DEB3G", "DEB3H", "DEB3I", "DEB3J", "DEB3K", "DEC01", "DEC02", "DEC03", "DEC04", "DEC05", "DEC06", "DED21", "DED2C", "DED2D", "DED2E", "DED2F", "DED41", "DED42", "DED43", "DED44", "DED45", "DED51", "DED52", "DED53", "DEE01", "DEE02", "DEE03", "DEE04", "DEE05", "DEE06", "DEE07", "DEE08", "DEE09", "DEE0A", "DEE0B", "DEE0C", "DEE0D", "DEE0E", "DEF01", "DEF02", "DEF03", "DEF04", "DEF05", "DEF06", "DEF07", "DEF08", "DEF09", "DEF0A", "DEF0B", "DEF0C", "DEF0D", "DEF0E", "DEF0F", "DEG01", "DEG02", "DE26C", "DE271", "DE272", "DE273", "DE274", "DE275", "DE276", "DE277", "DE278", "DE279", "DE27A", "DE27B", "DE27C", "DE27D", "DE27E", "DE300", "DE401", "DE402", "DE403", "DE404", "DE405", "DE406", "DE407", "DE408", "DE409", "DE40A", "DE40B", "DE40C", "DE40D", "DE40E", "DE40F", "DE40G", "DE40H", "DE40I", "DE501", "DE502", "DE600", "DE711", "DE712", "DE713", "DE714", "DE715", "DE716", "DE717", "DE718", "DE719", "DE71A", "DE71B", "DE71C", "DE71D", "DE71E", "DE721", "DE722", "DE723", "DE724", "DE725", "DE731", "DE732", "DE733", "DE734", "DE735", "DE736", "DE737", "DE803", "DE804", "DE80J", "DE80K", "DE80L", "DE80M", "DE80N", "DE80O", "DE911", "DE912", "DE913", "DE914", "DE916", "DE917", "DE918", "DE91A", "DE91B", "DE91C", "DE922", "DE923", "DE925", "DE926", "DE927", "DE928", "DE929", "DE931", "DE932", "DE933", "DE934", "DE935", "DE936", "DE937", "DE938", "DE939", "DE93A", "DE93B", "DE941", "DE942", "DE943", "DE944", "DE945", "DE946", "DE947", "DE948", "DE949", "DE94A", "DE94B", "DE94C", "DE94D")

NUTS3_codes <-c(NUTS3_codes, "DE94E", "DE94F", "DE94G", "DE94H", "DEA11", "DEA12", "DEA13", "DEA14", "DEA15", "DEA16", "DEA17", "DEA18", "DEA19", "DEA1A", "DEA1B", "DEA1C", "DEA1D", "DEA1E", "DEA1F", "DEA22", "DEA23", "DEA24", "DEA26", "DEA27", "DEA28", "DEA29", "DEA2A", "DEA2B", "DEA2C", "DEA2D", "DEA31", "DEA32", "DEA33", "DEA34", "DEA35", "DEA36", "DEA37", "DEA38", "DEA41", "DEA42", "DEA43", "DEA44", "DEA45", "DEA46", "DEA47", "DEA51", "DEA52", "DEA53", "DEA54", "DEA55", "DEA56", "DEA57", "DEA58", "DEA59", "DEA5A", "DEA5B", "DE213", "DE214", "DE215", "DE216", "DE217", "DE218", "DE219", "DE21A", "DE21B", "DE21C", "DE21D", "DE21E", "DE21F", "DE21G", "DE21H", "DE21I", "DE21J", "DE21K", "DE21L", "DE21M", "DE21N", "DE221", "DE222", "DE223", "DE224", "DE225", "DE226", "DE227", "DE228", "DE229", "DE22A", "DE22B", "DE22C", "DE231", "DE232", "DE233", "DE234", "DE235", "DE236", "DE237", "FRD11", "FRD12", "FRD13", "FRD21", "FRD22", "FRE11", "FRE12", "FRE21", "FRE22", "FRE23", "FRF11", "FRF12", "FRF21", "FRF22", "FRF23", "FRF24", "FRF31", "FRF32", "FRF33", "FRF34", "FRG01", "FRG02", "FRG03", "FRG04", "FRG05", "FRH01", "FRH02", "FRH03", "FRH04", "FRI11", "FRI12", "FRI13", "FRI14", "FRI15", "FRI21", "FRI22", "FRI23", "FRI31", "FRI32", "FRI33", "FRI34", "FRJ11", "FRJ12", "FRJ13", "FRJ14", "FRJ15", "FRJ21", "FRJ22", "FRJ23", "FRJ24", "FRJ25", "FRJ26", "FRJ27", "FRJ28", "FRK11", "FRK12", "FRK13", "FRK14", "FRK21", "FRK22", "FRK23", "FRK24", "FRK25", "FRK26", "FRK27", "FRK28", "FRL01", "FRL02", "FRL03", "FRL04", "FRL05", "FRL06", "FRM01", "FRM02", "FRY10", "FRY20", "DEG03", "DEG05", "DEG06", "DEG07", "DEG09", "DEG0A", "DEG0C", "DEG0D", "DEG0E", "DEG0G", "DEG0J", "DEG0K", "DEG0L", "DEG0M", "DEG0Q", "DEG0R", "DEG0S", "DEG0T", "DEG0U", "DEG0V", "DK011", "DK012", "DK013", "DK014", "DK021", "DK022", "DK031", "DK032", "DK041", "DK042", "DK050", "EE001", "EE004", "EE008", "EE009", "EE00A", "EL301", "EL302", "EL303", "EL304", "EL305", "EL306", "EL307", "EL411", "EL412", "EL413", "EL421", "EL422", "EL431", "EL432", "EL433", "EL434", "EL511", "EL512", "EL513", "EL514", "EL515", "EL521", "EL522", "EL523", "EL524", "EL525", "EL526", "EL527")

NUTS3_codes <-c(NUTS3_codes, "EL531", "EL532", "EL533", "EL541", "EL542", "EL543", "EL611", "EL612", "EL613", "EL621", "EL622", "EL623", "EL624", "EL631", "EL632", "EL633", "EL641", "EL642", "EL643", "EL644", "EL645", "EL651", "EL652", "EL653", "ES111", "ES112", "ES113", "ES114", "ES120", "ES130", "ES211", "ES212", "ES213", "ES220", "ES230", "ES241", "ES242", "ES243", "ES300", "ES411", "ES412", "ES413", "ES414", "ES415", "ES416", "ES417", "ES418", "ES419", "ES421", "ES422", "ES423", "ES424", "ES425", "ES431", "ES432", "ES511", "ES512", "ES513", "ES514", "ES521", "ES522", "ES523", "ES531", "ES532", "ES533", "ES611", "ES612", "ES613", "ES614", "ES615", "ES616", "ES617", "ES618", "ES620", "ES630", "ES640", "ES703", "ES704", "ES705", "ES706", "ES707", "ES708", "ES709", "FI196", "FI198", "FI199", "FI19A", "FI19B", "FI1B1", "FI1C1", "FI1C2", "FI1C5", "FI1C6", "FI1C7", "FI1D5", "FI1D7", "FI1D8", "FI1D9", "FI1DA", "FI1DB", "FI1DC", "FI200", "FR101", "FR102", "FR103", "FR104", "FR105", "FR106", "FR107", "FR108", "FRB01", "FRB02", "FRB03", "FRB04", "FRB05", "FRB06", "FRC11", "FRC12", "FRC13", "FRC14", "FRC21", "FRC22", "FRC23", "FRC24", "HU313", "HU321", "HU322", "HU323", "HU331", "HU332", "HU333", "IE041", "IE042", "IE051", "IE052", "IE053", "IE061", "IE062", "IE063", "IS001", "IS002", "ITC11", "ITC12", "ITC13", "ITC14", "ITC15", "ITC16", "ITC17", "ITC18", "ITC20", "ITC31", "ITC32", "ITC33", "ITC34", "ITC41", "ITC42", "ITC43", "ITC44", "ITC46", "ITC47", "ITC48", "ITC49", "NL415", "NL416", "NL421", "NL422", "NL423", "NO020", "NO060", "NO071", "NO072", "NO073", "NO081", "NO083", "NO084", "NO085", "NO092", "NO093", "NO094", "NO0A1", "NO0A2", "NO0A3", "NO0B1", "NO0B2", "PL213", "PL214", "PL217", "PL218", "PL219", "PL21A", "PL224", "PL225", "PL227", "PL228", "PL229", "PL22A", "PL22B", "PL22C", "PL411", "PL414", "PL415", "PL416", "PL417", "PL418", "PL424", "PL426", "PL427", "PL428", "PL431", "PL432", "PL514", "PL515", "PL516", "PL517", "PL518", "PL523", "PL524", "PL613", "PL616", "PL617", "PL618", "PL619", "PL621", "PL622", "PL623", "PL633", "PL634", "PL636", "PL637", "PL638", "PL711", "PL712", "ITC4A", "ITC4B", "ITC4C", "ITC4D")

NUTS3_codes <-c(NUTS3_codes, "ITF11", "ITF12", "ITF13", "ITF14", "ITF21", "ITF22", "ITF31", "ITF32", "ITF33", "ITF34", "ITF35", "ITF43", "ITF44", "ITF45", "ITF46", "ITF47", "ITF48", "ITF51", "ITF52", "ITF61", "ITF62", "ITF63", "ITF64", "ITF65", "ITG11", "ITG12", "ITG13", "ITG14", "ITG15", "ITG16", "ITG17", "ITG18", "ITG19", "ITG2D", "ITG2E", "ITG2F", "ITG2G", "ITG2H", "ITH10", "ITH20", "ITH31", "ITH32", "ITH33", "ITH34", "ITH35", "ITH36", "ITH37", "ITH41", "ITH42", "ITH43", "ITH44", "ITH51", "ITH52", "ITH53", "ITH54", "ITH55", "ITH56", "ITH57", "ITH58", "ITH59", "ITI11", "ITI12", "ITI13", "ITI14", "ITI15", "ITI16", "ITI17", "ITI18", "ITI19", "ITI1A", "ITI21", "ITI22", "ITI31", "ITI32", "ITI33", "ITI34", "ITI35", "ITI41", "ITI42", "ITI43", "ITI44", "ITI45", "LI000", "LT011", "LT021", "LT022", "LT023", "LT024", "LT025", "LT026", "LT027", "LT028", "LT029", "LU000", "LV005", "LV009", "LV00A", "LV00B", "LV00C", "ME000", "MK001", "MK002", "MK003", "MK004", "MK005", "MK006", "MK007", "MK008", "MT001", "MT002", "NL112", "NL114", "NL115", "NL126", "NL127", "NL128", "NL131", "NL132", "NL133", "NL211", "NL212", "NL213", "NL221", "NL224", "NL225", "NL226", "NL230", "NL321", "NL323", "NL325", "NL327", "NL328", "NL32A", "NL32B", "NL341", "NL342", "NL350", "NL361", "NL362", "NL363", "NL364", "NL365", "NL366", "NL411", "NL414", "FRY30", "FRY40", "FRY50", "HR021", "HR022", "HR023", "HR024", "HR025", "HR026", "HR027", "HR028", "HR031", "HR032", "HR033", "HR034", "HR035", "HR036", "HR037", "HR050", "HR061", "HR062", "HR063", "HR064", "HR065", "HU110", "HU120", "HU211", "HU212", "HU213", "HU221", "HU222", "HU223", "HU231", "HU232", "HU233", "HU311", "HU312", "TR412", "TR413", "TR421", "TR422", "TR423", "TR424", "TR425", "TR510", "TR521", "TR522", "TR611", "TR612", "TR613", "TR621", "TR622", "TR631", "TR632", "TR633", "TR711", "TR712", "TR713", "TR714", "TR715", "TR721")

NUTS3_codes <-c(NUTS3_codes, "TR722", "TR723", "TR811", "TR812", "TR813", "TR821", "TR822", "TR823", "TR831", "TR832", "TR833", "TR834", "TR901", "TR902", "TR903", "TR904", "TR905", "TR906", "TRA11", "TRA12", "TRA13", "TRA21", "TRA22", "TRA23", "TRA24", "TRB11", "TRB12", "TRB13", "TRB14", "TRB21", "TRB22", "TRB23", "TRB24", "TRC11", "TRC12", "TRC13", "TRC21", "TRC22", "TRC31", "TRC32", "TRC33", "TRC34", "PL713", "PL714", "PL715", "PL721", "PL722", "PL811", "PL812", "PL814", "PL815", "PL821", "PL822", "PL823", "PL824", "PL841", "PL842", "PL843", "PL911", "PL912", "PL913", "PL921", "PL922", "PL923", "PL924", "PL925", "PL926", "PT111", "PT112", "PT119", "PT11A", "PT11B", "PT11C", "PT11D", "PT11E", "PT150", "PT191", "PT192", "PT193", "PT194", "PT195", "PT196", "PT1A0", "PT1B0", "PT1C1", "PT1C2", "PT1C3", "PT1C4", "PT1D1", "PT1D2", "PT1D3", "PT200", "PT300", "RO111", "RO112", "RO113", "RO114", "RO115", "RO116", "RO121", "RO122", "RO123", "RO124", "RO125", "RO126", "RO211", "RO212", "RO213", "RO214", "RO215", "RO216", "RO221", "RO222", "RO223", "RO224", "RO225", "RO226", "RO311", "RO312", "RO313", "RO314", "RO315", "RO316", "RO317", "RO321", "RO322", "RO411", "RO412", "RO413", "RO414", "RO415", "RO421", "RO422", "RO423", "RO424", "RS110", "RS121", "RS122", "RS123", "RS124", "RS125", "RS126", "RS127", "RS211", "RS212", "RS213", "RS214", "RS215", "RS216", "RS217", "RS218", "RS221", "RS222", "RS223", "RS224", "RS225", "RS226", "RS227", "RS228", "RS229", "SE110", "SE121", "SE122", "SE123", "SE124", "SE125", "SE211", "SE212", "SE213", "SE214", "SE221", "SE224", "SE231", "SE232", "SE311", "SE312", "SE313", "SE321", "SE322", "SE331", "SE332", "SI031", "SI032", "SI033", "SI034", "SI035", "SI036", "SI037", "SI038", "SI041", "SI042", "SI043", "SI044", "SK010", "SK021", "SK022", "SK023", "SK031", "SK032", "SK041", "SK042", "TR100", "TR211", "TR212", "TR213", "TR221", "TR222", "TR310", "TR321", "TR322", "TR323", "TR331", "TR332", "TR333", "TR334", "TR411", "XK001", "XK002", "XK003", "XK004", "XK005", "XK006", "XK007")

NUTS.computation <- function(s){
  if(substr(s,1,2) %in% c("EU","EA","EF","CC","OE","G2","G7"))  return(s)
  if(nchar(s)==2 & s %in% NUTS0_codes) return("0")
  if(nchar(s)==3 & s %in% NUTS1_codes) return("1")
  if(nchar(s)==4 & s %in% NUTS2_codes) return("2")
  if(nchar(s)==5 & s %in% NUTS3_codes) return("3")
  return("OTHERS")
}
```


```{r}
for(col in colnames(data)){
  if(is.numeric(data[[col]])) next
  if(col=="TIME_PERIOD"){
    # print(col)
    # print(
    #   paste0("data.start: ",min(data[[col]]),
    #          ", data.end: ",max(data[[col]]),
    #          ", Number of time periods: ",length(unique(data[[col]]))
    #   )
    # )
    
    cat("\nCOLUMNA: TIME_PERIOD \n")
    print(
      data %>%
        group_by(TIME_PERIOD) %>%
        summarise(N.observ=dplyr::n())%>%
        as.matrix() %>%
        noquote()
    )
    next
  }
 if(col=="geo"){
    cat("\nCONTABILIZACIÓN Nº REGIONES NUTS A PARTIR DE LA COLUMNA geo\n")
    print(
      tibble(
        NUTS=sapply(unique(data[[col]]),NUTS.computation)
      ) %>%
        group_by(NUTS) %>%
        summarise(`Number of Regions`=dplyr::n()) %>%
        as.matrix() %>%
        noquote()
    )
    next
 }
  tb <-  data %>%
    left_join(get_eurostat_dic(col)%>%rename(!!col := code_name),
              by=col) %>%
    group_by(!!sym(col),full_name)%>%
    summarise(N.Observ=dplyr::n()) %>%
    relocate(N.Observ,.before = full_name)%>%
    arrange(desc(N.Observ)) %>%
    mutate(full_name=ifelse(nchar(full_name)<41,full_name,paste0(substr(full_name,1,40),"..")))
    
  texto <- paste0("COLUMNA: ",col)
  if(nrow(tb)>50){
    texto <- paste0(texto," (",nrow(tb)," opciones, se imprimen 50)")
    tb <- head(tb,50)
  }
  cat(texto,"\n")
  
  tb %>% 
    as.matrix() %>%
    noquote() %>%
    print()
}

```

### Percentiles de la distribución de tamaños de las series temporales

Observamos que el tamaño de las series temporales varía entre 1 y 29 años, siendo el 90% de las series con más de 22 años.  

```{r}
vars <- colnames(data)[1:(ncol(data)-2)]

data.series <- data %>%
  group_by(across(all_of(vars))) 

data.series.fechas <- data.series %>% 
  summarise(N.fechas=dplyr::n())
```

```{r}
percentiles <- tibble(min=min(data.series.fechas$N.fechas))
percentiles <- percentiles %>% mutate(min=min(data.series.fechas$N.fechas))
percentiles <- percentiles %>% mutate(p10=quantile(data.series.fechas$N.fechas, 0.1))
percentiles <- percentiles %>% mutate(p25=quantile(data.series.fechas$N.fechas, 0.25))
percentiles <- percentiles %>% mutate(p50=quantile(data.series.fechas$N.fechas, 0.50))
percentiles <- percentiles %>% mutate(p75=quantile(data.series.fechas$N.fechas, 0.75))
percentiles <- percentiles %>% mutate(p90=quantile(data.series.fechas$N.fechas, 0.9))
percentiles <- percentiles %>% mutate(max=max(data.series.fechas$N.fechas))

percentiles
```

### Distribución del nº de observaciones por regiones 

Observamos que, tanto para España como para Canarias, el nº de observaciones supera el `p75` de la distribución (1199 > 1159)

```{r}
data.geo <- data %>%
  group_by(geo)%>%
  summarise(N.Observ=dplyr::n())
```

**Percentiles de la distribución del nº de observaciones por regiones**
```{r}
percentiles <- tibble(min=min(data.geo$N.Observ))
percentiles <- percentiles %>% mutate(min=min(data.geo$N.Observ))
percentiles <- percentiles %>% mutate(p10=quantile(data.geo$N.Observ, 0.1))
percentiles <- percentiles %>% mutate(p25=quantile(data.geo$N.Observ, 0.25))
percentiles <- percentiles %>% mutate(p50=quantile(data.geo$N.Observ, 0.50))
percentiles <- percentiles %>% mutate(p75=quantile(data.geo$N.Observ, 0.75))
percentiles <- percentiles %>% mutate(p90=quantile(data.geo$N.Observ, 0.9))
percentiles <- percentiles %>% mutate(max=max(data.geo$N.Observ))

percentiles
```

**Nº de observaciones en España/Canarias**
```{r}
LocalRegionsFullNames <- c("Spain","Canarias","Canarias","El Hierro","Fuerteventura","Gran Canaria",
  "La Gomera","La Palma","Lanzarote","Tenerife")

LocalRegionsCodes <- c("ES","ES7","ES70","ES703","ES704","ES705","ES706","ES707","ES708","ES709")

LocalRegions <- tibble(
  geo=LocalRegionsCodes,
  full_name=LocalRegionsFullNames
)

data.geo %>%
  filter(geo %in% LocalRegionsCodes) %>%
  left_join(LocalRegions,by="geo") %>%
  relocate(full_name,.after = geo)
```


### Combinaciones existentes de las variables categóricas 

El dataset presenta 50 combinaciones únicas de variables categóricas (`freq`, `nace_r2`, `na_item`, `unit`), cumpliendo el criterio mínimo de tener al menos 5 atributos combinados con un número relativamente alto de observaciones (≈8600 observ.).  

```{r}
vars <- colnames(data)[1:(ncol(data)-3)]
vars <- vars[vars != "age"]
vars <- vars[vars != "sex"]

data.combinaciones <- data %>%
  group_by(across(all_of(vars))) 

data.combinaciones %>%
  summarise(N.observ=dplyr::n(),
            init.date=min(TIME_PERIOD),
            end.date=max(TIME_PERIOD)) %>%
  arrange(desc(N.observ)) %>% 
  print(n=50)
```

### Poner las fechas por columnas

Observamos que los datos se mantienen constantes desde el año 2000 hasta el 2023, registrando valores más altos en periodos recientes en comparación con los antiguos. 
  
```{r}
# pasamos las fechas a columnas de la tabla y añadimos algunos datos 
data.fechas <- data %>%
  pivot_wider(names_from = TIME_PERIOD,values_from = values,names_sort = FALSE) %>%
  #relocate(geo) %>% 
  left_join(get_eurostat_dic("geo"), join_by(geo==code_name)) %>%
  relocate(full_name,.after=geo)%>%
  mutate(NUTS=sapply(geo,NUTS.computation)) %>%
  relocate(NUTS)  %>%
  mutate(geo2=substr(geo,1,2)) %>% 
  left_join(get_eurostat_dic("geo")%>%rename(country=full_name),join_by(geo2==code_name)) %>%
  select(-geo2) %>% 
  rename(region=full_name) %>%
  relocate(country,.after = NUTS) %>%
  arrange(NUTS,country,geo)

#data.fechas
```

**Visualización España/Canarias (máximo 60 columnas y 1000 filas por región)**

```{r}
# visualización tabla para España y Canarias 
posRegion <- which(colnames(data.fechas) == "region")
Ncol <- ncol(data.fechas)
posSelect <- 1:Ncol 
if(Ncol>60) posSelect <- unique(c(1:posRegion,(Ncol-60):Ncol))

data.fechas %>%
  select(posSelect) %>% 
  filter(geo %in% LocalRegionsCodes) %>% 
  group_by(geo) %>%
  slice_head(n = 1000) %>%
  ungroup() %>% 
  relocate(region) %>% 
  datatable(
  extensions = 'FixedColumns',
  options = list(
    scrollX = TRUE,  
    scrollY = "400px", 
    paging = FALSE,     
    fixedColumns = list(leftColumns = 1) 
  ),
  class = "stripe hover nowrap",  
  rownames = FALSE  
)
```


## Preparación de los datos
<!-- desarrollo de esta fase -->

### Procesado inicial de los datos

El conjunto de datos original (`nama_10r_2lp10`) presentaba una estructura tidy pero requería una serie de transformaciones para garantizar su calidad y facilitar el análisis exploratorio. Se llevó a cabo un proceso de limpieza y enriquecimiento estructurado en las siguientes fases: 

#### 1. Selección de Atributos y Reducción de Dimensionalidad:  
Se eliminaron variables redundantes o carentes de varianza informativa. Concretamente, se descartó la columna `freq`, dado que presenta un valor único ("A") para todas las observaciones, indicando la periodicidad anual de la serie completa.  

#### 2. Estandarización de la Nomenclatura:  
Para mejorar la legibilidad del código y la manipulación de los datos, se renombraron las variables principales siguiendo un esquema semántico más claro:  

- `nace_r2` $\rightarrow$ `sector`  
- `na_item` $\rightarrow$ `item`  
- `TIME_PERIOD` $\rightarrow$ `year`  

#### 3. Enriquecimiento y Cruce de Datos:  
Se integró información geográfica y descriptiva externa para dotar de contexto a los códigos del dataset original:  

- *Información Geográfica:* Se realizó una unión con el dataset auxiliar (`urostac_real_nuts`). Esto permitió incorporar las columnas `NUTS` (nivel jerárquico) y `full_name` (nombre oficial de la región), claves para el análisis espacial.  
- *Descriptores Sectoriales:* Se generó una variable derivada, `sector_name`, que recodifica los códigos técnicos NACE Rev. 2 (ej. "O-U") en descripciones en lenguaje natural (ej. "Adm. pública, educación y salud"), facilitando la interpretación visual de los gráficos.

#### Estructura Final del Dataset: 
Tras el procesado, el dataset resultante consta de las siguientes variables dimensionadas para el análisis:

- Variables Geográficas: `geo` (Código), `NUTS` (Nivel 0, 1, 2), `full_name` (Etiqueta).  
- Variables Temporales: `year` (Serie 1995-2023).  
- Variables Categóricas: `sector` y `sector_name` (Rama de actividad).  
- Variables Métricas: `item` (Indicador), `unit` (Unidad de medida) y `values` (Valor numérico). Es importante destacar que el Coste laboral por hora trabajada es el único indicador que ofrece granularidad completa por sector; el resto de métricas (Coste por persona y Horas trabajadas) se presentan únicamente como valores agregados (Total).. 
```{r analisis-data-raw, results=F}
data_raw <- read_csv('data/nama_10r_2lp10.csv') %>% 
    as_tibble()

data_raw
```
```{r analisis-inicial, results=F}
real_names <- read_csv('data/eurostac_real_nuts.csv') %>% 
    as_tibble()


data <- data_raw %>% 
    select(-freq) %>% 
    rename(year = TIME_PERIOD, sector = nace_r2, item = na_item) %>% 
    left_join(real_names, by='geo') %>% 
    select(geo, NUTS, full_name, year, sector, item, unit, values) %>% 
    mutate(sector_name = case_when(
        sector == "TOTAL" ~ "Total actividades",
        sector == "O-U" ~ "Adm. pública, educación y salud",
        sector == "O-Q" ~ "Adm. pública, defensa y educación",
        sector == "B-E" ~ "Industria",
        sector == "K-N" ~ "Finanzas e inmobiliarias",
        sector == "F" ~ "Construcción",
        sector == "M_N" ~ "Profesionales y científicas",
        sector == "A" ~ "Agricultura y pesca",
        sector == "C" ~ "Manufactura",
        sector == "G-J" ~ "Comercio y transporte",
        sector == "R-U" ~ "Artes y otros servicios",
        sector == "G-I" ~ "Comercio y alojamiento",
        sector == "J" ~ "Información y comunicación",
        sector == "K" ~ "Finanzas",
        sector == "L" ~ "Inmobiliarias",
        TRUE ~ "Otro"
        )) %>% 
    relocate(sector_name, .after=sector)
    

data
```
```{r geoj, results=F}
geoj0 <- readRDS("data/geoj0.rds")
geoj1 <- readRDS("data/geoj1.rds")
geoj2 <- readRDS("data/geoj2.rds")

geoj0.tb <- geoj0 %>% as_tibble()
geoj1.tb <- geoj1 %>% as_tibble()
geoj2.tb <- geoj2 %>% as_tibble()
```

#### Definición del Indicador Clave: Coste Laboral

El eje central de este estudio es el Coste Laboral (representado en las gráficas como Coste por hora o Coste por empleado). Es fundamental aclarar que esta métrica refleja la **perspectiva del empleador**, no el bolsillo del empleado.  

Representa el coste total en el que incurre una empresa para emplear mano de obra. Esto abarca no solo la remuneración bruta (salarios y sueldos), sino también los costes no salariales, como las contribuciones sociales a cargo del empleador, impuestos laborales y otros gastos derivados.  

No debe confundirse con el salario neto que percibe el trabajador en su cuenta bancaria.  

#### Introducción: La Paradoja Europea

El objetivo de esta fase inicial no es solo describir los datos, sino comprender por qué España ocupa su posición actual. Para diagnosticar la realidad salarial en Canarias y el resto del país, es necesario ampliar el foco y observar primero el contexto macroeconómico. En este sentido, Europa actúa como un marco de referencia esencial: nos permite evaluar nuestro desempeño contrastándolo no con ideales teóricos, sino con la realidad tangible de los países de nuestro entorno.

La narrativa popular a menudo asocia la baja remuneración con una supuesta "falta de cultura del esfuerzo". Sin embargo, los datos sugieren una paradoja fundamental que será el hilo conductor de este capítulo: **en Europa, trabajar más horas no significa generar más riqueza; a menudo, significa lo contrario**.  

A través de las siguientes visualizaciones, estableceremos la "Tesis del presencialismo": demostraremos que existe una correlación negativa entre las horas trabajadas y el coste por hora, y ubicaremos a España en este tablero de juego antes de hacer zoom en sus regiones.  
<br>

Para comprender la posición actual de España, primero debemos analizar la inercia histórica. ¿Cómo han evolucionado los costes laborales en las últimas dos décadas?  

```{r evolucion-coste-hora-paises}
seleccion_paises <- c("Austria", "Belgium", "Denmark", "Finland", "France", "Germany", "Ireland", "Italy", "Luxembourg", "Netherlands", "Spain", "Sweden")

tb_top_evol <- data %>% 
    filter(full_name %in% seleccion_paises, item=="D1_SAL_HW", unit=="EUR", year>=2000) %>%
    group_by(full_name, year) %>% 
    summarise(mean_value = mean(values, na.rm = TRUE)) %>%  # media sobre todos los sectores
    ungroup() %>% 
    select(full_name, year, mean_value) %>% 
    arrange(mean_value)

p <- tb_top_evol %>% mutate(full_name = factor(full_name, levels=(unique(full_name)))) %>% 
    ggplot(aes(x=year,y=mean_value, group = full_name,
               text=paste0("<b>", full_name, "</b>",
                          "<br>Año: ", year,
                          "<br>Coste/Hora: ", round(mean_value, 2), "€"))) +
    geom_line() +
    labs(x="",y="", title="Evolución del coste por hora trabajada") +
    facet_wrap(~full_name, scales = "free_y") +
    theme(axis.text.x = element_text(angle = 45,hjust=1)) +
    theme(legend.position = "bottom",
        panel.grid.major = element_blank() # Elimina las líneas principales del grid
    )

ggplotly(p, tooltip = "text")
```

Esta visualización desglosa la evolución del coste por hora trabajada (2000-2022) mediante una serie de gráficos facetados.  
Lo primero que salta a la vista es una tendencia de crecimiento estructural unánime en toda Europa, pero los ejes verticales revelan rápidamente la trampa de la escala: el "techo" histórico de España (apenas superando los 25€) equivale al punto de partida de potencias como Dinamarca o Luxemburgo, confirmando que navegamos en carriles paralelos sin una convergencia real. Asimismo, prácticamente todas las gráficas exhiben la cicatriz del 2020, un pico artificial provocado por el desplome de horas durante la pandemia, y no por un aumento real de la productividad.

<br>
Si la gráfica anterior nos mostraba la velocidad de crecimiento, este mapa congela la imagen en 2022 para visualizar la distancia real en términos de riqueza y costes laborales por empleado.  

```{r mapa-coroplético}
tb <- geoj0.tb %>% 
    left_join(
        data %>% 
        filter(NUTS==0, item=="D1_SAL_PER", unit=="EUR", year==2022, sector=="TOTAL") %>% 
        na.omit(),
        join_by("NUTS_ID" == "geo")
        )

indices_validos <- !is.na(tb$values)

datos_filtrados <- tb[indices_validos, ]

geoj_filtrado <- geoj0[indices_validos, ]


etiquetas <-paste(
    "<strong> ",datos_filtrados$full_name ,
    "</strong><br>","Coste laboral por persona empleada",
    ": ",prettyNum(round(datos_filtrados$values,digits=2), big.mark = " ", scientific = FALSE)
  )  %>%
 lapply(htmltools::HTML)

MapaCoroplético(geoj_filtrado, datos_filtrados$values, etiquetas,"Coste laboral / persona (año 2022)")
```

El gradiente de color revela inmediatamente una frontera económica nítida: un "núcleo duro" europeo (Escandinavia, Benelux, Alemania, Francia) teñido de tonos cálidos que indican altos costes salariales, frente a una periferia sur y este que se diluye en tonos amarillos. En este tablero, España se encuentra en una incómoda "tierra de nadie": nuestros costes son superiores a los de Europa del Este, lo que nos impide competir por mano de obra barata, pero seguimos lejos de los estándares del norte, impidiéndonos competir por alto valor añadido.  

<br>
El mapa confirma el síntoma: cobramos significativamente menos que nuestros vecinos del norte. Ante esta realidad, surge inevitablemente el prejuicio cultural y la pregunta del millón: ¿Cobramos menos porque trabajamos menos? Para validar o descartar este mito, necesitamos mirar las horas trabajadas en promedio por empleado.

```{r top-bottom-horas}
# 1.1. Calcular la media semanal para TODOS los países
tb <- data %>% 
    filter(item == "HW_EMP", unit == "HW", NUTS == 0, year >= 2018) %>% 
    group_by(full_name) %>% 
    summarise(mean_hours = mean(values, na.rm = TRUE)) %>% 
    ungroup() %>% 
    mutate(mean_hours_week = mean_hours / 52.18) %>% # Horas por semana
    select(full_name, mean_hours_week) %>% 
    arrange(desc(mean_hours_week))

# 1.2. Identificar el valor de España
valor_espana <- tb %>%
    filter(full_name == "Spain") %>%
    pull(mean_hours_week)

# 1.3. Seleccionar Top 10, Bottom 10, y asegurar España (si no está ya)
tb_top <- head(tb, 5)
tb_bottom <- tail(tb, 5)

# Aseguramos que España esté incluida si no está en el Top/Bottom (aunque debería estar si son 20+ países)
# Usamos bind_rows y distinct para tener 20 países + España si es extra.
tb_combined <- bind_rows(tb_top, tb_bottom) %>%
    distinct(full_name, .keep_all = TRUE) %>% # Eliminar duplicados si España estaba en el límite
    # Añadimos una columna de color para España y el resto
    mutate(group = if_else(full_name == "Spain", "España", "Resto")) %>%
    # Ordenamos el factor para que el gráfico respete el orden de la tabla (Descendente)
    mutate(full_name = factor(full_name, levels = rev(full_name[order(mean_hours_week)])))


# --- 2. GENERACIÓN DEL GRÁFICO ÚNICO ---

p_final <- tb_combined %>%
    # x es el país (ordenado), y es el valor
    ggplot(aes(x = full_name, y = mean_hours_week, fill = full_name, text = paste("<b>", full_name, "</b>",  "<br>Horas semanales en promedio:", round(mean_hours_week, 1)))) +
    
    geom_bar(stat = "identity") +
    
    # Añadimos la línea de referencia de España
    geom_hline(yintercept = valor_espana, color = "red", linetype = "dashed", linewidth = 0.8) +
    
    # Invertimos el eje X y el Y, y pasamos las barras a horizontal
    coord_flip() + 
    
    # Texto de referencia para la línea de España
    annotate("text", 
         x = 9.5,  # <--- Posición vertical de la etiqueta (el país más bajo es 1)
         y = valor_espana + 2, 
         label = "Spain", 
         color = "red", 
         size = 4) +
    
    # Temas y Etiquetas
    labs(x = "", y = "Horas Trabajadas / Semana (Promedio 2018-23)", 
         title = "Distribución de la Carga Laboral Semanal (Top/Bottom 5)") +

    theme(legend.position = "none") # Quitamos la leyenda de los colores

# --- 3. RENDERIZADO INTERACTIVO ---
linea_interactiva <- data.frame(
  x_inicio = 0.5, # El inicio del eje categórico (barra 1)
  x_fin = length(unique(tb_combined$full_name)) + 0.5, # El final del eje categórico
  y_intercep = valor_espana,
  tooltip_linea = paste("Referencia España:", round(valor_espana, 1), "Horas/Semana")
)
p_final <- p_final + 
  geom_segment(data = linea_interactiva, 
               # Mapeamos x/y a los valores y la etiqueta al 'text'
               aes(x = x_inicio, xend = x_fin, 
                   y = y_intercep, yend = y_intercep, 
                   text = tooltip_linea), 
               inherit.aes = FALSE, # ¡Importante! No hereda las aes de los países
               color = "transparent", # Hacemos la línea invisible
               linewidth = 100) # Damos grosor para que sea fácil pasar el ratón

# Usamos ggplotly y especificamos que use el texto personalizado para los tooltips
ggplotly(p_final, tooltip = "text")
```

Al analizar la carga laboral semanal promedio, los datos desmontan radicalmente el estereotipo de la "pereza del sur". El gráfico de barras ordena a los países por horas trabajadas y el resultado es contraintuitivo: las economías más ricas y productivas (Alemania, Dinamarca, Países Bajos) ocupan la parte superior del gráfico con las jornadas más cortas, rondando las 26-28 horas semanales promedio. Por el contrario, los países con menores salarios (Grecia, Polonia, Croacia) presentan las jornadas más extensas, rozando las 40 horas. España, marcada por la línea roja discontinua, se sitúa por encima de la media europea en presencialismo, con una media en los últimos 5 años de 31.5 horas semanales. La conclusión es lapidaria: el esfuerzo en horas no garantiza la riqueza; de hecho, en Europa, parece correlacionar con lo contrario.  

<br>
Tenemos dos piezas del puzle que parecen contradictorias: los países ricos trabajan menos horas, y los países que trabajan más horas son más pobres. ¿Qué ocurre si cruzamos estas dos variables en un solo gráfico para ver su interacción directa?

```{r scatter, fig.height=6}
data_scatter <- data %>%
  # Filtramos solo Países (NUTS 0) y el total de la economía
  filter(full_name %in% seleccion_paises, sector == "TOTAL", year>=2000, year<2023) %>% 
  
  # Nos quedamos con las variables que nos interesan
  filter(item %in% c("HW_EMP", "D1_SAL_HW", "D1_SAL_PER")) %>%
  filter(unit %in% c("HW", "EUR")) %>% # Aseguramos unidades correctas
  
  # Seleccionamos columnas útiles
  select(geo, full_name, year, item, values) %>%
  
  # ¡MAGIA! Convertimos filas en columnas
  pivot_wider(names_from = item, values_from = values)


# 2. Creamos el objeto ggplot
p <- data_scatter %>%
  # Ordenamos por año para asegurar fluidez
  arrange(year) %>% 
  
  ggplot(aes(x = HW_EMP, y = D1_SAL_HW, color = full_name)) +
  
  # PUNTOS (Burbujas)
  geom_point(aes(
    size = D1_SAL_PER,   # Tamaño según coste total anual
    frame = year,        # Esto crea la animación por año
    ids = full_name,     # ¡Importante! Para que la burbuja se mueva suave y no parpadee
    text = paste0("<b>", full_name, "</b>",
                 "<br>Año: ", year,
                 "<br>Horas/Año: ", round(HW_EMP, 0),
                 "<br>Coste/Hora: ", round(D1_SAL_HW, 2), "€") # Tooltip bonito
  ), alpha = 0.7) +
  
  # Escalas y Títulos
  scale_size(range = c(2, 17)) + # Ajustamos tamaño burbujas min/max
  labs(
    x = "Horas Trabajadas por Empleado (Año)",
    y = "Coste Laboral por Hora (€)",
    title = "Horas trabajadas vs Coste por hora en Europa",
    color = "País",
    size = ""
  ) +
  
  # Tema limpio
  theme_minimal()

# 3. Renderizamos con Plotly y opciones de animación
ggplotly(p, tooltip = "text") %>% 
  animation_opts(
    frame = 600,       # Duración de cada año (ms)
    transition = 550,  # Duración del movimiento suave
    easing = "linear"
  ) %>%
  layout(
    title = list(
      text = "<b>Horas trabajadas vs Coste laboral:</b> Evolución Europea (2000-2022)",
      x = 0.5,
      xanchor = "center"
    ))
```

Esta visualización es la piedra angular del capítulo. Para interpretarla correctamente, debemos fijarnos en la dirección y el volumen: cuanto más arriba se sitúe un país, mayor es la remuneración por hora (eje Y), y cuanto más a la izquierda, menos horas se trabajan al año (eje X). Además, el tamaño de cada esfera es proporcional a ese coste: una bola grande indica un alto valor por hora, mientras que una pequeña señala precariedad.  

Al cruzar estas variables, emerge una clara correlación negativa: los países se alinean en una pendiente descendente. Las naciones más eficientes, como Luxemburgo o Dinamarca, se agrupan en la esquina superior izquierda (bolas grandes y pocas horas), mientras que a medida que nos desplazamos hacia la derecha, el valor generado cae y las esferas se hacen más pequeñas. España (la esfera morada en la zona inferior) queda relegada al cuadrante de "baja eficiencia": muchas horas de trabajo para un retorno por hora bajo. Finalmente, la animación temporal revela cómo el COVID-19 provocó un salto generalizado hacia la izquierda en 2020, una anomalía de reducción forzosa de horas que no debe confundirse con un aumento estructural de la productividad.

<br>
Ya hemos demostrado que el problema no es la cantidad de trabajo, sino el valor que generamos en ese tiempo. Pero, ¿es este bajo coste un problema generalizado en toda la economía o hay sectores que se salvan?

```{r boxplot-sectores}
p <- data %>%
  # Filtramos países, el indicador de Salario por Persona y aseguramos Euros
  filter(full_name %in% seleccion_paises, item == "D1_SAL_HW", unit == "EUR") %>%
  
  ggplot(aes(x = reorder(full_name,-values), y = values, fill = full_name)) +
  
  geom_boxplot() +
  
  # Rotamos los nombres del eje X para que se lean bien
  theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position = "none") +
  
  labs(x = "", y = "Coste por hora trabajada (€)",
       title = "Distribución del Coste Laboral por Hora en Europa")

ggplotly(p)
```

Para afinar el diagnóstico europeo, este diagrama de caja nos permite ver la "radiografía interna" de la desigualdad en cada país, mostrando no solo el promedio, sino la dispersión de los costes laborales. Mientras países como Luxemburgo o Dinamarca exhiben cajas altas y alargadas —indicando que tienen sectores capaces de alcanzar salarios muy elevados—, España muestra una caja mucho más comprimida y situada en la parte baja de la escala. Esto señala que nuestro "techo" salarial es estructuralmente bajo; incluso nuestros tramos mejor remunerados apenas compiten con los promedios de las potencias del norte.  

<br>
Sin embargo, el boxplot tiene una limitación: agrupa toda la economía en una sola "caja", ocultando los detalles específicos. Al ver esa compresión en los salarios españoles, surge la duda: ¿Es que pagamos mal en todos los sitios, o es que tenemos pocos sectores de alto valor? Para responder a esto, necesitamos desplegar esa caja y mirar sector por sector.  

```{r mapa-calor-sectores-eu}
tb <- data %>%
    filter(item == "D1_SAL_HW", unit == "EUR", NUTS == 0, year >= 2018) %>%
    group_by(full_name) %>%
    summarise(mean_value = mean(values, na.rm = TRUE)) %>%
    ungroup()

# Calculamos el valor de Pareto
pareto <- ParetoValue(tb$mean_value, 0.67) # Para quedarnos con 12 justo

countries_pareto <- data %>%
    filter(item == "D1_SAL_HW", unit == "EUR", NUTS == 0, year >= 2018) %>%
    group_by(full_name) %>%
    summarise(mean_value = mean(values, na.rm = TRUE)) %>%
    ungroup() %>% 
    filter(mean_value >= pareto) %>% 
    pull(full_name)

top_countries <- data %>% 
    filter(item=="D1_SAL_HW", unit=="PC_EU27_2020_MEUR_CP", year>=2018, full_name %in% countries_pareto) %>% 
    group_by(full_name, sector_name) %>%
    summarise(mean_value = mean(values, na.rm = TRUE)) %>% 
    ungroup() %>% 
    filter(mean_value>=pareto) %>% 
    filter(sector_name != "Total actividades")
    

p <- top_countries %>% 
    # **AÑADE ESTA LÍNEA:** Excluye la fila donde el nombre del sector sea "Total actividades"

    ggplot(aes(reorder(full_name, -mean_value), sector_name, 
               # Renombramos aquí para el FILL, y también añadimos TEXT para el tooltip
               fill = mean_value, 
               text = paste0("<b>", full_name, "</b>",
                            "<br>Sector: ", sector_name,
                            "<br>Valor :", round(mean_value, 2), "%"))) +
    
    # También podemos simplificar estas dos líneas, ya que no vamos a resaltar nada
    # geom_tile(aes(color = sector_name == "Total actividades"), linewidth = 0.75) +
    # scale_color_manual(values = c("TRUE" = "black", "FALSE" = "grey80"), guide = "none") +

    # Versión simplificada SIN borde negro condicional:
    geom_tile() +
    
    scale_fill_gradient(low = "white", high = "steelblue") +
    labs(x = "", y = "", title = "Coste laboral medio por sector y país (2018-23)",fill = "Índice (UE27 = 100)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(tooltip = "text")
```

Si el diagrama de cajas nos sugería un problema general, este mapa de calor confirma que la desventaja es estructural y relativa. Para este análisis, hemos utilizado un índice normalizado donde 100 representa la media de la UE-27. La interpretación es directa: cualquier valor superior a 100 indica que el sector rinde por encima del estándar europeo, mientras que valores inferiores señalan una desventaja competitiva.

El resultado es un degradado vertical implacable: mientras las columnas de la izquierda (Luxemburgo, Dinamarca) acumulan valores muy superiores a 100, el dato más revelador para nuestro estudio es que España presenta valores inferiores a 100 en prácticamente toda la matriz. Esto significa que no tenemos ningún sector que actúe como "punta de lanza" real; incluso nuestras industrias de alto valor añadido operan sistemáticamente por debajo del promedio continental en términos de coste y valoración relativa.

<br>
Europa nos ha enseñado que trabajar más horas no es la solución. España está atrapada en un modelo de alto presencialismo y bajo valor añadido. Para entender cómo hemos llegado aquí y si hay esperanza de cambio, necesitamos dejar el mapa europeo y hacer zoom sobre nuestra propia historia reciente.

#### Crisis y Convergencia: Trayectoria España

Dejamos el mapa europeo con una conclusión amarga: España trabaja mucho para generar poco valor relativo. Pero, ¿siempre ha sido así? ¿Hemos mejorado con el tiempo o estamos estancados? Para responder a esto, dejamos de mirar a los vecinos y colocamos la lupa sobre la economía española para analizar su evolución en las últimas dos décadas. Lo que encontramos no es una línea de crecimiento sostenido, sino un proceso marcado por la volatilidad y dos caídas económicas.  

```{r variacion-salarios}
df_variation <- data %>%
  filter(full_name == "Spain", NUTS == 0, sector == "TOTAL", item == "D1_SAL_PER", unit == "EUR") %>%
  arrange(year) %>%
  group_by(full_name) %>%
  # Cálculo de la variación porcentual interanual (Perfecto como lo tienes)
  mutate(variation_pct = (values / lag(values) - 1) * 100) %>%
  ungroup() %>%
  drop_na() # Quitamos el NA del primer año

# --- 2. GENERACIÓN DEL GRÁFICO INTERACTIVO (PLOTLY) ---
p_variation_plotly <- df_variation %>%
  plotly::plot_ly(
    x = ~year, 
    y = ~variation_pct, 
    type = 'scatter', 
    mode = 'lines+markers',
    name = 'Variación % Anual',
    line = list(color = '#1F77B4')
  ) %>%
  
  # Configuración y Layout (Limpieza de ejes)
  layout(
    title = "Variación Anual % del Coste Laboral por persona empleada en España",
    xaxis = list(title = "Año", tickmode = 'linear', dtick = 5), # Muestra años cada 5 para limpiar el eje
    yaxis = list(title = "Variación Porcentual (%)"),
    showlegend = FALSE
  )

ggplotly(p_variation_plotly)
```

Esta serie temporal representa la variación porcentual del coste laboral año tras año, y actúa como un sismógrafo de nuestra historia reciente. Lejos de la estabilidad deseada, vemos una montaña rusa. Observamos el optimismo de la burbuja inmobiliaria (2000-2008) con crecimientos cercanos al 4-5%, seguido del desplome tras la crisis financiera, tocando fondo con valores negativos en 2012 (año de la reforma laboral y los recortes).  
Sin embargo, el dato más engañoso aparece al final: ese pico vertical en 2020 que roza el 6% de "crecimiento". No nos dejemos engañar; al igual que vimos en Europa, esto no es riqueza real. Es una ilusión estadística provocada por la pandemia: el coste unitario subió porque las horas trabajadas se desplomaron mientras los mecanismos de protección (ERTEs) sostenían las rentas. Esta volatilidad nos indica que nuestro modelo reacciona a los golpes externos con virulencia, pero, ¿hacia dónde nos ha llevado todo este movimiento?  

<br>
Si convertimos estos altibajos en una trayectoria de movimiento, ¿hemos avanzado hacia la eficiencia europea (arriba e izquierda) o simplemente estamos dando vueltas en círculos?

```{r direccion-evolucion}
df_snail <- data %>%
  filter(
    full_name == "Spain", 
    NUTS == 0,
    sector == "TOTAL", # Análisis agregado nacional
    item %in% c("D1_SAL_HW", "HW_EMP"),
    unit %in% c("EUR", "HW")
  ) %>%
  select(year, full_name, item, values) %>%
  
  # Pivotar a formato ancho para que los indicadores sean columnas
  pivot_wider(names_from = item, values_from = values) %>%
  drop_na(D1_SAL_HW, HW_EMP) %>%
  arrange(year) # Esencial: ordena por año para que la línea siga la secuencia


# --- 2. GENERACIÓN DEL GRÁFICO (Connected Scatter Plot) ---
p_snail <- df_snail %>%
  # Mapeamos el color y el label al año
  ggplot(aes(x = HW_EMP, y = D1_SAL_HW, color = year, group = 1,
             text = paste0("Año: ", year,
                          "<br>Horas: ", round(HW_EMP, 0),
                          "<br>Coste/Hora: ", round(D1_SAL_HW, 2), "€"))) +
  
  # 2.1. El camino que conecta los años cronológicamente
  geom_path(color = "gray", linewidth = 0.8) +
  
  # 2.2. Los puntos (las paradas en cada año)
  geom_point(size = 2) +
  
  # Labels
  labs(
    title = "Trayectoria de la Eficiencia Laboral en España (2000-2023)",
    x = "Horas Trabajadas Anuales por Empleado",
    y = "Coste Laboral por Hora (€)",
    color = "Año"
  ) +
  
  # Tema y Escala de Color
  scale_color_viridis_c() + # Escala de color que va cambiando con el tiempo
  theme(legend.position = "none")

# 3. Interactividad (para ver los tooltips al pasar el ratón)
ggplotly(p_snail, tooltip = "text")
```

Este gráfico es quizás la prueba más contundente de la memoria. Aquí trazamos el viaje de la economía española desde 2000 hasta 2023, conectando cada año con el siguiente. El eje X representa las horas trabajadas (presencialismo) y el eje Y el coste laboral (valor/riqueza).  

La forma resultante recuerda a un caracol o un muelle que se contrae. Partimos en el 2000 (esquina inferior derecha) con muchas horas y muy poco valor. A lo largo de los años, nos hemos desplazado hacia la izquierda, reduciendo la jornada media anual de unas 1.750 horas a cerca de 1.630. Sin embargo, el movimiento vertical —el aumento de riqueza— ha sido penosamente lento. La "cicatriz" del 2020 es visible como un bucle errático en la parte superior (puntos amarillos), donde saltamos hacia la izquierda y arriba artificialmente, para luego corregir. La conclusión es dura: España ha reducido el esfuerzo (horas), pero no ha logrado disparar la eficiencia (valor). Nos movemos, pero no despegamos.  

<br>
Si el "caracol" anterior nos mostraba un crecimiento promedio lento, este gráfico de líneas nos revela el culpable: la media española es una ficción que esconde una economía de doble velocidad. Al desglosar la evolución del coste por hora trabajada sector por sector, observamos una divergencia brutal. 

```{r evolucion-sectores-españa}
  data_vars <- data %>%
    filter(
      item == "D1_SAL_HW",
      unit == "EUR",
      geo == "ES",
      sector != "TOTAL"
    ) %>%
    arrange(year)

  # 4. CREACIÓN DEL GRÁFICO
  #    Base: Las regiones variables
  hc <- hchart(
  data_vars, 
  type = "line",
  # CORRECCIÓN CLAVE AQUÍ ABAJO:
  # Cambiamos group = full_name por group = sector_name (o nace_r2)
  # para que dibuje una línea por cada sector, no una sola línea loca.
  hcaes(x = year, y = values, group = sector_name), 
  marker = list(enabled = TRUE, symbol = "circle", radius = 3)
)
  
hc %>% hc_title(text = "Evolución del Coste Laboral por Sector (España)") %>%
    hc_xAxis(title = list(text = "Año")) %>% 
    hc_yAxis(title = list(text = "Coste por hora trabajada (€)"))
```

En la parte superior, sectores como Finanzas (línea verde oscura superior) y las Industrias Extractivas/Energía han escalado posiciones con fuerza, alcanzando costes por hora superiores a los 40€, cifras que empiezan a competir con Europa. Sin embargo, la gravedad de la estructura productiva española se hace evidente en la parte inferior de la gráfica: una maraña de líneas planas que agrupan a sectores masivos como la Hostelería (Comercio y alojamiento) y la Agricultura. Estos sectores apenas han logrado despegar de la franja de los 10€ - 15€ por hora en más de dos décadas.

La conclusión es clara: España no tiene un problema único de productividad; tiene sectores "locomotora" que tiran hacia arriba, pero están lastrados por "vagones" muy pesados de bajo valor añadido que mantienen el promedio nacional estancado.

<br>
El análisis de nuestra historia reciente confirma que las cicatrices de las crisis no se han curado igual para todos. Mientras algunos sectores han logrado modernizarse y encarecer su hora de trabajo, gran parte del tejido productivo sigue atrapado en costes bajos. Hemos visto la trayectoria temporal (el estancamiento) y la culpable sectorial (la divergencia).  
Pero, ¿dónde se ubican físicamente estos sectores? ¿Están distribuidos uniformemente por el país o hemos creado zonas de riqueza y pobreza? Para responder a esto, debemos romper el mapa nacional.

#### Heterogeneidad Geográfica

Al descender del nivel nacional al regional, confirmamos que España no es una economía monolítica, sino un puzle de realidades divergentes. Si en Europa vimos una brecha Norte-Sur, es crucial verificar si ese patrón se replica dentro de nuestras fronteras. Para ello, vamos a confrontar directamente dos variables que la narrativa popular suele unir: lo que ganamos (riqueza) frente a lo que trabajamos (esfuerzo).  

```{r mapas-comparativos}
# Preparación de datos (Coste Persona)
geoj_esp <- geoj2[substr(geoj2$NUTS_ID, 1, 2) == "ES", ]
geoj_esp.tb <- geoj_esp %>% as_tibble()

tb_coste <- geoj_esp.tb %>% 
    left_join(
        data %>% 
        filter(substr(geo, 1, 2) == "ES" & NUTS == 2, item=="D1_SAL_PER", unit=="EUR", year==2023, sector=="TOTAL") %>% 
        na.omit(),
        by = join_by("NUTS_ID" == "geo")
        )

etiquetas_coste <-paste(
    "<strong> ",tb_coste$full_name ,
    "</strong><br>","Coste laboral por persona empleada",
    ": ",prettyNum(round(tb_coste$values,digits=2), big.mark = " ", scientific = FALSE)
  )  %>%
  lapply(htmltools::HTML)

# Generar el primer mapa y guardarlo en una variable
mapa_coste <- MapaCoropléticoES(geoj_esp, tb_coste$values, etiquetas_coste, "Coste empleado (2023)")


# -------------------------
# MAPA 2: HORAS TRABAJADAS
# -------------------------

# Preparación de datos (Horas Trabajadas)
tb_horas <- geoj_esp.tb %>% 
    left_join(
        data %>% 
        filter(substr(geo, 1, 2) == "ES" & NUTS == 2, item=="HW_EMP", unit=="HW", year==2023, sector=="TOTAL") %>% 
        na.omit(),
        by = join_by("NUTS_ID" == "geo")
        )

etiquetas_horas <-paste(
    "<strong> ",tb_horas$full_name ,
    "</strong><br>","Horas trabajadas anuales",
    ": ",prettyNum(round(tb_horas$values,digits=2), big.mark = " ", scientific = FALSE)
  )  %>%
  lapply(htmltools::HTML)

# Generar el segundo mapa y guardarlo en una variable
mapa_horas <- MapaCoropléticoES(geoj_esp, tb_horas$values, etiquetas_horas, "Horas anuales (2023)")


# -------------------------
# SALIDA FINAL ALINEADA
# -------------------------

# Usamos htmltools::tagList() para devolver ambos mapas al mismo tiempo.
# RMarkdown los alineará horizontalmente gracias a las opciones del chunk (out.width y fig.show).
htmltools::div(
  style="width: 1080px; margin-left: calc(50% - 540px);",
  htmltools::div(
    style = "display: inline-block; width: 49%; vertical-align: top",
    mapa_coste
  ),
  htmltools::div(
    style = "display: inline-block; width: 49%; vertical-align: top",
    mapa_horas
  )
)
```

Al colocar estos dos mapas frente a frente, emerge un patrón revelador: existe una correlación visual inversa. Lo que es oscuro en un mapa, tiende a ser claro en el otro, y viceversa.  

- **El Mapa de la Riqueza (Izquierda):** El cuadrante noreste y Madrid aparecen en tonos oscuros y rojizos, señalando las zonas de mayor coste laboral y riqueza.  

- **El Mapa del Esfuerzo (Derecha):** Justo esas mismas zonas "ricas" (Madrid, País Vasco) se tiñen aquí de tonos más claros (amarillos), indicando jornadas laborales más cortas. Por el contrario, las zonas que en el mapa de riqueza aparecían pálidas (Castilla-La Mancha, Murcia, Extremadura), aquí se oscurecen hacia el rojo, indicando jornadas más largas.  

La imagen es contraintuitiva pero clara: las regiones más ricas son las que menos horas trabajan. Madrid, la "isla de calor" salarial, es una zona "fría" en horas. En cambio, regiones con menor renta como Canarias o el sur peninsular presentan colores más intensos en esfuerzo. Esto demuestra que la pobreza relativa no es fruto de la pereza; de hecho, las regiones con menor coste laboral tienden a compensar su menor productividad estructural con un mayor presencialismo.  

```{r boxplot-sectores-NUTS2}
p <- data %>%
  # Filtramos países, el indicador de Salario por Persona y aseguramos Euros
  filter(substr(geo, 1, 2) == "ES" & NUTS == 2, item == "D1_SAL_HW", unit == "EUR", !full_name %in% c("Ciudad de Melilla", "Ciudad de Ceuta")) %>%
  
  ggplot(aes(x = reorder(full_name,-values), y = values, fill = full_name)) +
  
  geom_boxplot() +
  #coord_flip() +
  
  # Rotamos los nombres del eje X para que se lean bien
  theme(axis.text.x = element_text(angle = 45, hjust = 1),legend.position = "none") +
  
  labs(x = "", y = "Coste por hora trabajada (€)", title = "Distribución del Coste Laboral por Hora en España")

ggplotly(p)
```

Este diagrama de cajas desagrega la realidad nacional por Comunidades Autónomas, permitiéndonos observar la dispersión real de los salarios dentro de cada territorio. La jerarquía es clara y dolorosa.  

- **La Élite Salarial:** En la parte izquierda, *Comunidad de Madrid*, *País Vasco* y *Navarra* lideran el ranking con las medianas más altas. Pero lo más relevante es la altura de sus cajas y los "bigotes" superiores. Fijaos en la nube de puntos negros (outliers) sobre Madrid: indican que existe un segmento del mercado laboral capaz de alcanzar costes muy superiores a los 40€/hora. Allí, el ascensor social hacia salarios altos funciona.  

- **El Vagón de Cola:** En el extremo derecho, encontramos a *Extremadura*, *Murcia* y *Canarias*. En el caso específico de Canarias, la caja no solo está situada abajo (mediana rondando los 16€), sino que está "comprimida". A diferencia de Madrid, Canarias apenas tiene dispersión hacia arriba; sus outliers son escasos. Esto confirma la existencia de un "techo de cristal regional". En Canarias, la estructura económica comprime los salarios en una franja estrecha y baja. Incluso los perfiles mejor pagados de las islas tienen dificultades para superar la mediana de las comunidades con mejor remuneración.  

<br>
El análisis geográfico ha sido devastador para el prejuicio del esfuerzo. Hemos visto una inversión de roles: las zonas ricas trabajan menos y las zonas "pobres" trabajan más. Canarias se esfuerza tanto o más que el norte, pero su estructura actúa como una losa que impide que ese tiempo se traduzca en valor.  

Si trabajamos más horas para generar menos riqueza y chocamos con un techo salarial bajo... **la causa no puede ser geográfica, tiene que ser sectorial.** ¿En qué trabajamos los canarios para que nuestro esfuerzo valga tan poco?  

#### La Causa Raíz: Estructura Sectorial

Hemos recorrido un largo camino para descartar culpables. Sabemos que no es un problema de "ser españoles" (Europa nos mostró nuestra ineficiencia relativa), ni de las crisis (que afectaron a todos), ni siquiera de vivir en el sur o en una isla (el mapa de esfuerzo nos absolvió).  
Si trabajamos prácticamente las mismas horas que en el norte pero generamos la mitad de riqueza, la única variable que nos queda es la **naturaleza del trabajo**. El mercado no remunera el esfuerzo bruto, sino el valor añadido y la escalabilidad. Existen actividades donde la tecnología actúa como una palanca que multiplica exponencialmente el rendimiento de cada hora invertida, mientras que otros sectores enfrentan límites estructurales naturales, donde la productividad está acotada por la pura presencia física, independientemente de la dedicación del trabajador. En este capítulo, abrimos la "caja negra" de la economía para demostrar que la desigualdad regional no es más que **desigualdad sectorial disfrazada de geografía**.  

```{r donut-sectores-es23}
# --- 1. PREPARACIÓN Y FILTRADO DE DATOS ---

tb_plotly <- data %>%
  filter(
    geo == "ES", 
    item == "D1_SAL_HW", 
    unit == "EUR", 
    year == 2023, 
    sector != "TOTAL"
  ) %>%
  group_by(sector_name) %>%
  # Calculamos la suma total del Coste por Hora por sector para el porcentaje
  summarise(total_value = sum(values, na.rm = TRUE)) %>% 
  ungroup() %>%
  drop_na()

# --- 2. GENERACIÓN DEL GRÁFICO DINÁMICO (PLOTLY DONUT) ---

p_donut_dinamico <- tb_plotly %>%
  plotly::plot_ly(
    labels = ~sector_name,
    values = ~total_value,
    textposition = 'inside',
    # Configuración de texto y orientación (como en tu ejemplo)
    textinfo = 'label+percent',
    insidetextorientation = 'radial',
    hovertemplate = paste(
        "<b>%{label}</b><br>",
        "Coste por hora: %{value:,.2f}€<br>",
        "Porcentaje: %{percent}<extra></extra>"
        )
  ) %>%
  
  # Añadimos el agujero y quitamos la leyenda para dejar el gráfico limpio
  add_pie(hole = 0.3) %>%
  
  layout(
    title = "Distribución del Coste Laboral por Sector (España, 2023)",
    showlegend = FALSE, # Quitamos la leyenda
    # Aseguramos que el gráfico se muestre como círculo
    xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
    yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE)
  )

ggplotly(p_donut_dinamico)
```

Para entender el problema, analicemos la estructura de precios de la economía española. Este gráfico de anillo no representa el volumen de empleo ni el PIB, sino el **peso relativo del coste por hora de cada sector** en el conjunto de la oferta económica. Es decir, visualiza qué sectores son "caros" y cuáles "baratos".  

Observamos una clara jerarquía de valor. El sector Finanzas (11.5%) y la Información y Comunicación (8.85%) ocupan una porción significativa del gráfico. Esto indica que son actividades con un alto coste unitario: su hora de trabajo se cotiza muy por encima de la media. En contraposición, sectores masivos como Agricultura (2.57%), Hostelería (Comercio y alojamiento, 6.2%) o Artes (5.01%) tienen un peso relativo mucho menor. Esto revela que su hora de trabajo aporta un valor monetario unitario mucho más bajo al total nacional.  

<br>
Sin embargo, este gráfico nos muestra una "España media" que no existe en la realidad. La pregunta clave es: ¿Están estas "porciones caras" del anillo repartidas equitativamente por el país, o están acaparadas por unas pocas regiones? Para descubrirlo, necesitamos desenrollar este gráfico y proyectar el coste de cada sector sobre el mapa de las Comunidades Autónomas.  

```{r mapa-calor-sectores-CCAA}
top_comunidades_ES <- data %>% 
    filter(item=="D1_SAL_HW", unit=="EUR", year>=2018, substr(geo, 1, 2) == "ES" & NUTS==2) %>% 
    group_by(full_name, sector_name) %>%
    summarise(mean_value = mean(values, na.rm = TRUE)) %>% 
    ungroup()
    
p <- top_comunidades_ES %>% 
    # **AÑADE ESTA LÍNEA:** Excluye la fila donde el nombre del sector sea "Total actividades"

    ggplot(aes(reorder(full_name, -mean_value), sector_name, 
               # Renombramos aquí para el FILL, y también añadimos TEXT para el tooltip
               fill = mean_value, 
               text = paste0("<b>", full_name, "</b>",
                            "<br>Sector: ", sector_name,
                            "<br>Coste: ", round(mean_value, 2), "€/Hora"))) +
    
    # También podemos simplificar estas dos líneas, ya que no vamos a resaltar nada
    # geom_tile(aes(color = sector_name == "Total actividades"), linewidth = 0.75) +
    # scale_color_manual(values = c("TRUE" = "black", "FALSE" = "grey80"), guide = "none") +

    # Versión simplificada SIN borde negro condicional:
    geom_tile() +
    
    scale_fill_gradient(low = "white", high = "steelblue") +
    labs(x = "", y = "", title = "Coste laboral medio por sector y CCAA (2018-23)", fill = "Coste por hora") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(tooltip = "text")
```

Esta visualización actúa como el diagnóstico definitivo del proyecto. Al cruzar cada comunidad autónoma con sus sectores productivos, el código de color revela una jerarquía implacable: la fila de Finanzas cruza el mapa como una viga maestra de azul intenso (especialmente en Madrid), mientras que actividades como Comercio y alojamiento o Agricultura se diluyen en tonos pálidos casi idénticos en todo el territorio. El problema de Canarias se hace aquí evidente y visual; no es que seamos menos productivos por ser isleños, es que nuestra economía habita masivamente en esas filas inferiores de color blanco ("los sectores pálidos"), mientras que las regiones ricas basan su liderazgo en acumular fichas en los sectores "azules" de alto valor añadido. La desigualdad geográfica es, en esencia, una desigualdad de especialización.  

<br>
Ya tenemos al culpable. No es el mapa, es el menú. España sufre de una estructura donde los sectores de alto valor (Finanzas, Tecnología) actúan como islas de riqueza concentradas en Madrid y el Norte, mientras que territorios como Canarias funcionan como enormes plataformas de servicios de bajo coste (Hostelería o Agricultura, entre otros).  
La pregunta final es inevitable. Si ya sabemos que el sector es el destino... ¿Está Canarias condenada por su especialización turística? ¿Es posible tener un sector turístico eficiente y bien pagado, o estamos atrapados en una trampa de pobreza estructural?

#### Conclusión: El Caso de Canarias

Hemos viajado desde los datos macroeconómicos del continente hasta la estructura sectorial nacional. Ahora, aterrizamos en el "paciente cero" de nuestra tesis: **Canarias**. Si nuestra hipótesis es correcta —que el problema es el modelo productivo y no el trabajador—, los datos deberían mostrar una región que se esfuerza tanto o más que Europa, pero cuyo retorno económico se estanca, desacoplándose de los estándares de bienestar continentales.

```{r horas-trabajadas-evolucion}
tb <- data %>%
  filter(
    geo %in% c("ES", "ES7", "EU27_2020"),
    item == "HW_EMP",
    unit == "HW"
  ) %>%
  mutate(
    full_name = case_when(
      geo == "ES7" ~ "Canarias",
      geo == "ES" ~ "España",
      geo == "EU27_2020" ~ "Media UE",
      TRUE ~ full_name
    )
  )

# Colores personalizados
colores <- c(
  "Canarias" = "red",
  "España" = "#1F77B4",
  "Media UE" = "lightgreen"
)

p <- ggplot(tb, aes(x = year, y = values, color = full_name, group = full_name, 
                    text = paste("<b>",full_name,"</b>",
                                 "<br>Año:", year,
                                 "<br>Horas anuales:", values,
                                 "<br>Horas semanales:", round(values / 52.18, 1)))) +
  geom_line(linewidth = 0.8) +
  scale_color_manual(values = colores) +
  labs(
    title = "Evolución de las horas trabajadas anuales por empleado",
    x = "Año",
    y = "Horas",
    color = "Región"
  )

ggplotly(p, tooltip = "text")
```

Comenzamos el juicio final presentando la prueba definitiva de la defensa. Este gráfico compara la evolución de las horas trabajadas por empleado en Canarias (rojo), España (azul) y la media de la Unión Europea (verde).  

El resultado destruye el mito de la "pereza meridional". Históricamente, **Canarias ha trabajado sistemáticamente más horas que la media europea**. Mientras la línea verde de la UE muestra una tendencia descendente clara hacia la eficiencia (trabajar menos horas), la línea roja de Canarias se mantiene por encima, resistiéndose a bajar de las 1.650 horas anuales (salvo el shock del COVID en 2020). Por tanto, concluimos que el trabajador canario dedica más tiempo a su empleo que el europeo promedio. La pobreza salarial no es fruto de la falta de dedicación.  

```{r brecha-salario-ESIC}
# --- 1. PREPARACIÓN DE DATOS (WIDE y LONG) ---

# Preparamos el dataset WIDE (necesario para geom_ribbon)
df_brecha_wide <- data %>%
  filter(
    (full_name %in% c("Spain") & NUTS == 0) | 
    (full_name %in% c("Canarias") & NUTS == 2),
    item == "D1_SAL_PER",
    unit == "EUR",
    sector == "TOTAL"
  ) %>%
  select(year, full_name, values) %>%
  pivot_wider(names_from = full_name, values_from = values) %>%
  drop_na() %>%
  rename(España = Spain) # Renombramos para usar "España"

# Convertimos a formato LONG (necesario para geom_point y tooltip)
df_brecha_long <- df_brecha_wide %>%
  pivot_longer(cols = c(España, Canarias), names_to = "Región", values_to = "Valor")


# --- 2. GENERACIÓN DEL GRÁFICO (Puntos y Tooltip) ---
p_brecha_final <- df_brecha_wide %>%
  ggplot(aes(x = year)) +
  
  # 1. Geom_Ribbon (Área de la brecha - usa el formato WIDE)
  geom_ribbon(aes(ymin = Canarias, ymax = España), 
              fill = "#FF7F0E", alpha = 0.4) +
  
  # 2. Geom_Line y Geom_Point (Líneas, puntos y Tooltip - usan el formato LONG)
  geom_line(data = df_brecha_long, aes(y = Valor, color = Región, group = Región), linewidth = 1) +
  
  # AÑADIDO: Puntos y Tooltip
  geom_point(data = df_brecha_long, aes(y = Valor, color = Región,
                                        text = paste0("<b>", Región, "</b>",
                                                     "<br>Año: ", year,
                                                     "<br>Coste/Persona: ", round(Valor, 0), "€")
                                        ), size = 2) + # Tamaño del punto más visible
  
  # Labels y Estilo
  labs(
    title = "<b>Evolución de la Brecha Salarial:</b> Coste por Empleado (España vs. Canarias)",
    y = "Coste por Persona Empleada (€)",
    x = "Año",
    color = "Región"
  ) +
  
  scale_color_manual(values = c("Canarias" = "red", "España" = "#1F77B4")) +
  
  theme_minimal()

# 3. Renderizado interactivo
ggplotly(p_brecha_final, tooltip = "text")
```

Descartado el esfuerzo, miramos el resultado monetario. Este gráfico de área visualiza la distancia entre ser empleado en la Península (azul) y serlo en las Islas (rojo).

La imagen revela un desacople progresivo. A principios de los 2000, las líneas caminaban paralelas. Sin embargo, tras la crisis financiera de 2008, la "boca" del gráfico se abre dramáticamente. Mientras España recupera tracción y supera los 30.000€ de coste por empleado, Canarias se queda rezagada, ampliando la zona naranja (la brecha) año tras año. Esto confirma que la convergencia regional se ha roto: la insularidad económica pesa cada vez más.

Transición: Ya sabemos que perdemos contra España. Pero, si levantamos la vista y nos comparamos con el estándar europeo ("Gold Standard"), ¿en qué sectores estamos perdiendo realmente?

<br>
Ya sabemos que perdemos contra España. Pero, si levantamos la vista y nos comparamos con el estándar europeo ("Gold Standard"), ¿en qué sectores estamos perdiendo realmente?

```{r sectores-wrapped-ESIC, fig.height=6}
# --- 1. PREPARACIÓN DE DATOS BASE ---
df_facet <- data %>%
  filter(
    # Filtramos por España y Canarias (NUTS 0 y NUTS 2)
    (full_name %in% c("Spain") & NUTS == 0) | 
    (full_name %in% c("Canarias") & NUTS == 2) |
    (geo == "EU27_2020"),
    item == "D1_SAL_HW",
    unit == "EUR",
    sector != "TOTAL" # Excluimos el total para ver los sectores individuales
  ) %>%
  # Renombrar Spain para que la leyenda se vea mejor
  mutate(
  full_name = case_when(
    full_name == "Spain" ~ "España",
    full_name == "Canarias" ~ "Canarias",
    geo == "EU27_2020" ~ "Media UE")) %>% 
  drop_na(values)


# --- 2. GENERACIÓN DEL GRÁFICO (FACET WRAP) ---
p_facet_time_series <- df_facet %>%
  ggplot(aes(x = year, y = values, color = full_name, group = full_name)) +
  
  geom_line(linewidth = 0.5,
            aes(text = paste("<b>", full_name, "</b>",
                     "<br>Sector:", sector_name,
                     "<br>Año:", year,
                     "<br>Coste/Hora:", round(values, 2), "€"))) +
  
  # Dividir el gráfico por sector: scales="free_y" ajusta el eje Y a cada sector
  facet_wrap(~sector_name, scales = "free_y") + 
  
  # Labels
  labs(
    title = "Evolución Sectorial del Coste Laboral por Hora: España vs. Canarias",
    subtitle = paste0("Periodo: ", min(df_facet$year), " - ", max(df_facet$year)),
    y = "Coste por Hora (€)",
    x = "Año",
    color = "Región"
  ) +
  
  # Temas y Estilo
  scale_color_manual(values = c("Canarias" = "red", "España" = "#1F77B4", "Media UE" = "lightgreen")) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    legend.position = "bottom",
    panel.grid.major = element_blank(), # Elimina las líneas principales del grid
    panel.spacing = unit(5, "pt")
  )

ggplotly(p_facet_time_series, tooltip = "text")
```

Aquí es donde la realidad se torna severa. Al añadir la línea de la Media UE (verde) a nuestras series temporales, descubrimos una "Doble Velocidad" estructural.

- **Sectores de Convergencia (Bajo Valor):** En sectores como Hostelería (Comercio y alojamiento) o Construcción, las tres líneas viajan relativamente juntas. Canarias (rojo) compite de tú a tú en costes con Europa. Somos competitivos siendo "baratos".

- **Sectores de Divergencia (Alto Valor):** La tragedia aparece en los sectores que definen el futuro. Si nos fijamos en Información y Comunicación, Finanzas o Actividades Profesionales. La línea verde (UE) se dispara hacia arriba con una pendiente agresiva, indicando una alta generación de valor. España (azul) intenta seguirla a distancia. Pero Canarias (rojo) se queda plana o crece muy lentamente. Por tanto En los sectores tecnológicos y profesionales, Canarias no está convergiendo; Europa se está escapando a una velocidad inalcanzable para nuestro modelo actual.

```{r dubmbell-plot}
max_year <- max(data$year, na.rm = TRUE)

df_dumbbell <- data %>%
  filter(
    full_name %in% c("Spain", "Canarias"),
    item == "D1_SAL_HW",
    unit == "EUR",
    year == max_year, # Snapshot del último año
    sector != "TOTAL" 
  ) %>%
  select(sector_name, full_name, values) %>%
  mutate(full_name = if_else(full_name == "Spain", "España", full_name)) %>% 
  drop_na()

# 2. Generación del gráfico de mancuernas (Dumbbell Plot)
p_dumbbell <- df_dumbbell %>%
  
  mutate(sector_name = fct_reorder(sector_name, values, .fun = mean, na.rm = TRUE)) %>%
  
  # 2.1. Mapeamos el color general
  ggplot(aes(x = values, y = sector_name, color = full_name)) +
  
  # Línea que conecta los puntos (la 'mancuerna')
  geom_line(aes(group = sector_name), color = "grey", linewidth = 1) +
  
  # Puntos (las 'pesas') - Aquí metemos el tooltip y ajustamos el tamaño
  geom_point(
    # AÑADIDO: Tooltip SÓLO en los puntos
    aes(text = paste("<b>", full_name, "</b>",
                     "<br>Sector:", sector_name,
                     "<br>Coste/Hora:", round(values, 2), "€")), 
    size = 2.5 # AJUSTE: Hacemos los puntos más pequeños (antes 4)
  ) +
  
  # Configuración de color y leyenda
  scale_color_manual(values = c("Canarias" = "red", "España" = "#1F77B4"), name = "Región") +
  
  # Etiquetas y Títulos
  labs(
    title = "Brecha Sectorial del Coste por Hora",
    subtitle = ("España vs Canarias (Año 2023)"),
    x = "Coste Laboral por Hora (€)",
    y = "Sector Laboral"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

# 3. Renderizado interactivo
ggplotly(p_dumbbell, tooltip = "text")
```

Antes de cerrar, hacemos zoom en la fricción interna. Este gráfico de mancuernas mide la distancia salarial exacta entre trabajar en las islas o en la península.

Confirmamos la **"penalización insular del talento":** las líneas grises son mucho más largas en los sectores cualificados (*Información y comunicación*, *Industria*, *Finanzas*) que en los básicos (*Agricultura*, *Artes*). Esto explica la fuga de talento nacional: un ingeniero informático canario tiene un incentivo monetario enorme para mudarse a Madrid (la línea gris es muy larga), mientras que para un trabajador del sector primario la diferencia es mínima.

```{r top4sectores-canarias}
# Filtrado de Canarias y ordenamiento
tb_canarias <- data %>% 
    filter(geo == "ES7", item == "D1_SAL_HW", unit == "EUR", year == 2023, sector != "TOTAL") %>% 
    arrange(values)

top <- tb_canarias %>% 
    tail(4) %>% 
    pull(sector)

bottom <- tb_canarias %>%
    head(4) %>% 
    pull(sector)

tb <- data %>% 
    filter(geo %in% c("ES7", "ES", "EU27_2020"), item == "D1_SAL_HW", unit == "EUR", year == 2023, sector != "TOTAL") %>% 
      mutate(
  full_name = case_when(
    full_name == "Spain" ~ "España",
    full_name == "Canarias" ~ "Canarias",
    geo == "EU27_2020" ~ "Media UE")
      )


# # 2. COMBINACIÓN Y CLASIFICACIÓN DE SECTORES
# df_plot <- bind_rows(
#     top %>% mutate(Sector_Type = "Top 4 (Mejor Remunerado)"),
#     bottom %>% mutate(Sector_Type = "Bottom 4 (Peor Remunerado)")
# )
colores <- c("Canarias" = "red", "España" = "#1F77B4", "Media UE" = "lightgreen")
colores_tipo <- c("Top" = "black", "Bottom" = "gray")

df_plot <- tb %>% 
    filter(sector %in% top | sector %in% bottom) %>% 
    mutate(Sector_Type = ifelse(sector %in% top, "Top", "Bottom"))

# 3. GENERACIÓN DEL GRÁFICO (Barra horizontal con referencia)
p_top_bottom <- df_plot %>%
    ggplot(aes(x = reorder(sector_name, values), y = values, fill = full_name, color = Sector_Type)) +
    
    # Barras (coord_flip requiere hjust = -0.1 para texto fuera)
    geom_bar(
      stat = "identity", 
      position = "dodge",
      aes(text = paste("<b>", full_name, "</b>",
                       "<br>Sector:", sector_name, 
                       "<br>Coste/Hora:", round(values, 2), "€"))
    ) +
    
    # Temas y Labels
    scale_color_manual(values = colores_tipo) +
    scale_fill_manual(values = colores) +
    labs(title = paste("Contraste Salarial Sectorial en Canarias (", 2023, ")"),
         subtitle = "Comparación Top 3 y Bottom 3 vs. Media Nacional de Coste por Hora",
         y = "Coste Laboral por Hora (€)",
         x = "",
         fill = "Región",
         color = "Top / Bottom en Canarias") +
    theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.major.x = element_blank())

ggplotly(p_top_bottom, tooltip = "text")
```

Cerramos el estudio con esta "foto fija" del valor en 2023. Comparamos los 4 sectores peor pagados (contorno gris) y 4 mejor pagados (contorno negro) de Canarias (rojo); contra España (azul) y Europa (verde).

Al analizar la altura de las barras, el patrón que emerge es revelador. En los sectores vinculados a la *Administración Pública, Educación y Salud*, observamos una convergencia sorprendente: la barra roja de Canarias roza la altura de la media europea (barra verde), actuando el Estado como un escudo que iguala los salarios.  

Sin embargo, el abismo se abre drásticamente en los sectores privados impulsados por el talento, independientemente de si están en el grupo de menor remuneración o mayor. El contraste más doloroso lo encontramos en *Actividades Profesionales y Científicas* e *Información y Comunicación*. En ambos casos, la barra verde de la UE se dispara muy por encima de la canaria. Esto confirma que allí donde el salario depende de la competitividad tecnológica y el mercado global, Canarias sufre su mayor desconexión con Europa, mientras que el empleo público maquilla las estadísticas generales.  

Lo más impactante es la degradación del valor del conocimiento: un sector clave como *Profesionales y científicas*, que en Europa supera holgadamente los 30€/hora, en Canarias aparece hundido en el grupo de los peor pagados, con una barra roja (~19€) que apenas se despega de los servicios básicos. La brecha aquí es devastadora: el mercado local está pagando el talento técnico casi a la mitad de su precio europeo.  

## Modelado
<!-- desarrollo de esta fase -->
Tras la exploración visual de los datos, en esta fase aplicamos técnicas matemáticas para cuantificar las relaciones observadas y proyectar tendencias futuras. El objetivo no es solo describir qué ocurre, sino validar matemáticamente por qué ocurre y qué ocurrirá si el modelo actual persiste.

```{r regresion-lineal}
# --- 1. PREPARACIÓN Y PIVOTADO DE DATOS ---

# Filtramos los dos indicadores de interés y nos aseguramos de usar las unidades correctas
tb_comparacion_estatica <- data %>%
  filter(
    item %in% c("D1_SAL_HW", "HW_EMP"),
    unit %in% c("EUR", "HW"),
    NUTS==0
  ) %>%
  
  # Seleccionamos las columnas clave para el pivote
  select(full_name, year, sector_name, item, values) %>%
  
  # Transformamos a formato ancho para que D1_SAL_HW (Eje Y) y HW_EMP (Eje X) sean columnas
  pivot_wider(
    names_from = item, 
    values_from = values,
    values_fn = mean # Usamos mean por si hay duplicados menores en el dataset
  ) %>%
  
  # Limpiamos los NAs que impiden la comparación
  drop_na(D1_SAL_HW, HW_EMP)


# --- 2. GENERACIÓN DEL DIAGRAMA DE DISPERSIÓN ESTÁTICO ---

# --- 2. GENERACIÓN DEL DIAGRAMA DE DISPERSIÓN ESTÁTICO CORREGIDO ---

p_dispersion_estatica <- tb_comparacion_estatica %>%
  
  # 1. Quitamos la estética 'text' de aquí para que geom_smooth NO la herede
  ggplot(aes(x = HW_EMP, y = D1_SAL_HW, color = full_name)) + 
  
  # 2. Añadimos la estética 'text' SÓLO a geom_point
  geom_point(aes(text = paste("País:", full_name,
                             "<br>Año:", year,
                             "<br>Horas Trabajadas:", round(HW_EMP, 0),
                             "<br>Coste por Hora:", round(D1_SAL_HW, 2), "€")),
             alpha = 0.5) +
  
  # 3. geom_smooth ahora hereda SOLO x e y, por lo que se renderiza correctamente
  geom_smooth(method = lm, se = FALSE, color = "#333333", linewidth = 0.8) +
  
  # Etiquetas y Títulos
  labs(
    x = "Horas Trabajadas por Empleado (HW)", 
    y = "Coste Laboral por Hora (€)",
    title = "Relación entre Horas Trabajadas y Coste por Hora (1995-2023)",
    subtitle = "Cada punto representa una observación (Región/Sector/Año)"
  ) +
  
  theme_minimal() +
  theme(legend.position = "none")

# Visualizar el gráfico. Plotly encontrará el canal 'text' en los puntos.
ggplotly(p_dispersion_estatica, tooltip = "text")
```

Para confirmar la "Paradoja de la Eficiencia" detectada en el Acto I, hemos aplicado un modelo de Regresión Lineal Simple sobre el conjunto de datos de países europeos (1995-2023).  

- Variable Independiente ($X$): Horas Trabajadas por Empleado.  
- Variable Dependiente ($Y$): Coste Laboral por Hora.  

El modelo arroja una recta de regresión con **pendiente negativa** clara (línea negra). El coeficiente de correlación (negativo) confirma estadísticamente que existe una relación inversa: a medida que aumentan las horas trabajadas en una economía, el coste por hora tiende a disminuir.Matemáticamente, esto refuta la hipótesis de que la baja remuneración en España o Canarias se deba a una falta de intensidad laboral. Los datos se ajustan a un modelo donde la "fuerza bruta" (más horas) penaliza el valor unitario.  
<br>
<hr>
<br>
Una vez descartadas las horas como factor de riqueza, utilizamos técnicas multivariantes para identificar qué sectores actúan como "motores" y cuáles como "lastres" en la economía de las Comunidades Autónomas.

```{r matriz-dispersion}
data %>% 
  filter(item=="D1_SAL_HW", unit=="EUR", substr(geo, 1, 2) == "ES" & NUTS == 2) %>%  
  group_by(full_name, sector_name) %>%
  summarise(values=mean(values)) %>%
  ungroup() %>%
  pivot_wider(names_from = sector_name, values_from = values) %>%
  na.omit() %>% 
  select(-full_name) %>% 
  cor(use = "complete.obs") %>% 
  plot_correlation(show_values = TRUE) 
```

Hemos calculado la matriz de correlación utilizando los datos desagregados por Comunidades Autónomas. El objetivo es medir la fuerza de la relación lineal entre el peso de cada sector y la variable objetivo: Total Actividades (Coste medio total).  

Los resultados dividen la economía en dos bloques matemáticos:  

- Correlaciones Positivas (Cercanas a 1 - Motores de Riqueza): Observamos correlaciones fuertes y positivas en sectores como "Información y comunicación" y "Actividades Profesionales". Matemáticamente, esto significa que cuanto mayor es el peso de estos sectores en una región, mayor es su sueldo medio total.

- Correlaciones Débiles o Negativas (Cercanas a 0 - Lastres): Sectores como "Agricultura" o "Manufactura" muestran correlaciones bajas o incluso negativas con el coste total. Esto implica que una especialización excesiva en estas áreas no contribuye estadísticamente a elevar la media salarial de la región.
<br>
<hr>
<br>
Para visualizar cómo se agrupan las regiones según su "ADN económico", aplicamos un Análisis de Componentes Principales (PCA). Este algoritmo reduce la complejidad de todos los sectores a menos dimensiones, permitiéndonos ver qué regiones se parecen entre sí.

```{r visualizacion-pca}
tb <- data %>%
      filter(item=="D1_SAL_HW", unit=="EUR", substr(geo, 1, 2) == "ES" & NUTS == 2)%>% 
      group_by(Región = full_name, sector_name) %>%
      summarise(values=mean(values)) %>%
      ungroup() %>%
      pivot_wider(names_from = sector_name, values_from = values) %>%
      na.omit()

pca_ccaa <- tb %>%
        column_to_rownames(var="Región") %>% 
        prcomp(scale = TRUE)

hchart(pca_ccaa, choices = c(1, 2))
```

El gráfico resultante es un mapa de la "Doble España":

- **Los Vectores de la Modernidad:** Fíjense en las líneas (vectores) que apuntan hacia la derecha: corresponden a Finanzas, Información y comunicación y Profesionales y científicas. Estos son los sectores que "tiran" de la economía hacia el cuadrante positivo.

- **El Clúster Rico:** Madrid, Navarra y País Vasco aparecen aisladas en el extremo derecho, alineadas perfectamente con la dirección de esos vectores de alto valor. Su posición no es casualidad; es la consecuencia matemática de su estructura.

- **El Clúster de la Dependencia:** En el lado opuesto (izquierda), encontramos agrupadas a regiones como Extremadura, Castilla-La Mancha o Andalucía. Estas regiones están "lejos" de la influencia de los vectores tecnológicos, quedando relegadas estructuralmente en el mapa de la eficiencia.
<br>
<hr>
<br>
Finalmente, para responder a la pregunta de si la brecha es coyuntural o estructural, hemos usado un modelo ARIMA sobre las series temporales de coste laboral por hora, para España y para Canarias.

```{r funcion-doble-arima}
plot_forecast_dual <- function(serie1, serie2,
                               pred1, pred2,
                               time_var, value_var,
                               titulo = "Proyección") {
  
  # Convertir nombres de columnas a símbolos
  time_sym  <- rlang::sym(time_var)
  value_sym <- rlang::sym(value_var)
  
  # --------------------------
  # 1) Preparar series originales
  # --------------------------
  serie1_df <- serie1 %>%
    as_tibble() %>%
    mutate(serie = "Canarias")
  
  serie2_df <- serie2 %>%
    as_tibble() %>%
    mutate(serie = "España")
  
  # --------------------------
  # 2) Función: procesar predicción (intervalos + media)
  # --------------------------
  prep_pred <- function(pred_df, label) {
    pred_df %>%
      hilo(level = 95) %>%
      unpack_hilo(`95%`) %>%
      as_tibble() %>%
      rename(lower = `95%_lower`, upper = `95%_upper`) %>%
      mutate(serie = label)
  }
  
  pred1_df <- prep_pred(pred1, "Canarias")
  pred2_df <- prep_pred(pred2, "España")
  
  # --------------------------
  # 3) Función: añadir fila ancla
  # --------------------------
  add_anchor <- function(history, pred, time_sym, value_sym) {
    
    # último dato real
    last_real <- tail(history, 1)
    
    # copiar estructura de pred[1,]
    anchor <- pred[1, ]
    
    # sustituir valores
    anchor[[rlang::as_string(time_sym)]]  <- last_real[[rlang::as_string(time_sym)]]
    anchor$.mean  <- last_real[[rlang::as_string(value_sym)]]
    anchor$lower  <- last_real[[rlang::as_string(value_sym)]]
    anchor$upper  <- last_real[[rlang::as_string(value_sym)]]
    
    # devolver predicción con fila ancla arriba
    dplyr::bind_rows(anchor, pred)
  }
  
  # aplicar ancla a cada serie
  pred1_df <- add_anchor(serie1_df, pred1_df, time_sym, value_sym)
  pred2_df <- add_anchor(serie2_df, pred2_df, time_sym, value_sym)
  
  # combinar predicciones
  preds_df <- bind_rows(pred1_df, pred2_df)
  
  # combinar historias
  history_df <- bind_rows(serie1_df, serie2_df)
  
  # --------------------------
  # 4) Gráfico
  # --------------------------
  p <- ggplot() +
    geom_ribbon(
      data = preds_df,
      aes(x = !!time_sym, ymin = lower, ymax = upper, fill = serie),
      alpha = 0.2
    ) +
    geom_line(
      data = history_df,
      aes(x = !!time_sym, y = !!value_sym, color = serie),
      linewidth = 1
    ) +
    geom_line(
      data = preds_df,
      aes(x = !!time_sym, y = .mean, color = serie),
      linewidth = 1, linetype = "dashed"
    ) +
    scale_color_manual(values = c("Canarias"="red", "España"="#1F77B4")) +
    scale_fill_manual(values = c("Canarias"="red", "España"="#1F77B4")) +
    labs(
      title = titulo,
      subtitle = "Predicción con intervalos de confianza del 95%",
      x = time_var, y = value_var,
      color = "Serie", fill = "Serie"
    ) +
    theme_minimal(base_size = 13)
  
  ggplotly(p, tooltip = c(time_var, value_var, "serie"))
}

```
```{r doble-arima}
# CANARIAS
remun.canarias <- data %>% 
    filter(geo == "ES7", item=="D1_SAL_HW", unit=="EUR", sector=="TOTAL") %>% 
    select(year, values) %>% 
    as_tsibble(index = year) %>% 
    rename(Año = year, Valor = values) %>% 
    fill_gaps()

remun.canarias.arima <- remun.canarias %>% 
    model(ARIMA(Valor))

remun.canarias.prediccion <- remun.canarias.arima %>%
     forecast(h="5 years")

# ESPAÑA
remun.españa <- data %>% 
    filter(geo == "ES", item=="D1_SAL_HW", unit=="EUR", sector=="TOTAL") %>% 
    select(year, values) %>% 
    as_tsibble(index = year) %>% 
    rename(Año = year, Valor = values) %>% 
    fill_gaps()

remun.españa.arima <- remun.españa %>% 
    model(ARIMA(Valor))

remun.españa.prediccion <- remun.españa.arima %>%
     forecast(h="5 years")

# GRÁFICO DE LOS 2 ARIMAS
plot_forecast_dual(remun.canarias, remun.españa, remun.canarias.prediccion, remun.españa.prediccion, "Año", "Valor", "Predicción de la remuneración por hora trabajada (España vs Canarias)")
```

El modelo proyecta el comportamiento para los próximos 5 años con intervalos de confianza del 95%.

- **La Tendencia de España (Azul)**: Muestra una pendiente de crecimiento sostenida, impulsada por la tracción de sus zonas industriales y de servicios avanzados.
- **La Tendencia de Canarias (Rojo)**: Muestra un crecimiento mucho más moderado.

Lo más alarmante es la divergencia de las áreas sombreadas (intervalos de confianza). Las proyecciones no se tocan; se separan. El modelo matemático predice que, si la estructura sectorial no cambia, la brecha salarial no se cerrará por inercia, sino que tenderá a cronificarse o ensancharse. Canarias no está convergiendo hacia la media nacional; estadísticamente, se está desacoplando.

## Evaluación
<!-- desarrollo de esta fase -->

Para garantizar que las conclusiones extraídas del apartado de modelado son robustas y no fruto del azar, hemos sometido a los modelos predictivos a una evaluación de desempeño mediante la métrica RMSE (*Root Mean Square Error*). Esta métrica cuantifica el error promedio de la predicción expresado en las mismas unidades que la variable objetivo (Euros por hora).  

Los resultados obtenidos validan una alta fiabilidad en las proyecciones:  

- **Serie España:** El algoritmo seleccionó un modelo <ARIMA(1,1,0) w/ drift>. El RMSE obtenido es de 0.35, lo que indica que el error promedio del modelo es de apenas 35 céntimos de euro sobre el coste real.  

- **Serie Canarias:** Se ajustó un modelo <ARIMA(0,1,1) w/ drift>. El RMSE es de 0.42, implicando un margen de error de 42 céntimos.  

Considerando que los costes laborales oscilan entre los 20€ y 30€, errores inferiores a 0.50€ representan una desviación mínima. La presencia del componente drift (tendencia) en ambos modelos, junto con estos bajos niveles de error, confirma estadísticamente que la divergencia futura observada en las gráficas no es ruido estadístico, sino una tendencia estructural sólida y predecible. Podemos confiar en que, sin cambios externos, la brecha salarial seguirá el camino trazado.


## Despliegue
<!-- desarrollo de esta fase -->

El valor de un proyecto de Ciencia de Datos no reside solo en las conclusiones estáticas de una memoria, sino en la capacidad de entregar herramientas que permitan a otros usuarios explorar, verificar y descubrir nuevos patrones. Por ello, el producto final de este trabajo es un Cuadro de Mandos Interactivo (Dashboard) desarrollado con `flexdashboard` y `Shiny`.

Esta herramienta no es una simple galería de imágenes; es una aplicación web reactiva que permite al usuario navegar por todo el ciclo de vida del dato, desde la exploración visual hasta la predicción algorítmica.

A continuación, se detallan los módulos funcionales que componen el aplicativo:

### Módulos Funcionales

#### Exploración Temporal (Pestaña "Series Temporales")
Este módulo permite analizar la evolución histórica de cualquier indicador disponible en el dataset.  

- **Funcionalidad:** El usuario puede seleccionar indicadores (ej. Coste Laboral), unidades y regiones específicas.  

- **Visualización Flexible:** Ofrece dos modos de visualización:  

    - **Facetado (Separados):** Para ver la tendencia limpia de cada país individualmente.  
    - **Superpuesto:** Para comparar directamente las curvas de crecimiento entre regiones (ej. Canarias vs. Media UE) en un mismo eje.

#### Análisis Geoespacial (Pestaña "Mapa Coroplético")
Diseñado para identificar patrones territoriales y desigualdades geográficas.  

- **Visión Macro y Micro:** Permite visualizar el mapa completo de Europa (NUTS 0) para cualquier año e indicador.

- **Drill-down Regional:** Incorpora una funcionalidad avanzada de "profundidad". Al seleccionar un país concreto en el filtro, el mapa se redibuja automáticamente para mostrar la granularidad interna de ese país (regiones NUTS 1/2). Esto es fundamental para observar las diferencias internas, como la brecha Norte-Sur en España o Italia.

#### Laboratorio de Relaciones (Pestaña "Comparación de Atributos")
Este módulo permite al usuario actuar como analista, cruzando libremente cualquier variable del dataset (Eje X vs. Eje Y) para detectar correlaciones.  

- **Transformaciones Estadísticas:** Dado que los datos económicos suelen presentar asimetrías, el dashboard permite aplicar transformaciones matemáticas en tiempo real sobre los ejes, incluyendo escalas logarítmicas y la transformación de Yeo-Johnson, esencial para normalizar distribuciones complejas.  

- **Correlación Sectorial:** Permite cambiar el foco de "Regiones" a "Sectores", visualizando cómo interactúan las distintas ramas de actividad económica entre sí.

#### Motor de Predicción (Pestaña "Predicción ARIMA")
Integra los modelos de Machine Learning desarrollados en el proyecto para proyectar el futuro.  

- **Forecasting a la Carta:** El usuario puede seleccionar cualquier región y métrica para generar una predicción a 5 o menos años vista.  

- **Transparencia del Modelo:** El dashboard no es una "caja negra"; muestra dinámicamente el ajuste del modelo (línea roja discontinua vs. real), calcula el error RMSE en tiempo real y especifica qué hiperparámetros ARIMA $(p,d,q)$ han sido seleccionados automáticamente por el algoritmo.  

- **Ventana Deslizante:** Permite ajustar el año de inicio de los datos de entrenamiento para verificar cómo se comportaría el modelo en distintos periodos históricos.

#### Estructura Latente (Pestaña "Análisis de Atributos")
Dedicada al análisis multivariante para entender la composición sectorial.

- **Granularidad:** Permite alternar el análisis entre Países Europeos y Comunidades Autónomas.  

- **Herramientas Avanzadas:** Incluye visualizaciones de la Matriz de Correlación (Heatmap), varianza explicada y la proyección de los Componentes Principales (PCA), permitiendo identificar visualmente los clústeres de regiones ricas vs. regiones dependientes.

### Experiencia de Usuario y Reactividad
El desarrollo se ha regido por principios de usabilidad y robustez técnica:

- **Lógica Condicional (Reactive Logic):** El cuadro de mandos es "inteligente". Los selectores están encadenados lógicamente para evitar errores; por ejemplo, si el usuario selecciona el indicador "Horas Trabajadas", el selector de unidades ocultará automáticamente la opción "Euros", mostrando solo las unidades temporales válidas. Esto asegura la coherencia de los análisis generados.  

- **Interactividad Total:** Todos los gráficos (generados con plotly y highcharter) son interactivos, permitiendo hacer zoom, paneo y consultar valores exactos mediante tooltips al pasar el ratón, facilitando la exploración de datos densos.  

Este despliegue garantiza que las conclusiones del estudio sean reproducibles, auditables y extensibles por cualquier interesado en la economía regional europea.

### Publicación Web Estática (GitHub Pages)

Adicionalmente, se ha configurado el repositorio para desplegar la versión compilada de la memoria (HTML) a través de *GitHub Pages*. Esto actúa como un release estable del documento narrativo. A diferencia del dashboard, que requiere un servidor de cálculo activo (R), esta versión estática permite que **cualquier usuario con el enlace** pueda acceder a la lectura completa del informe, los análisis y las gráficas interactivas desde cualquier dispositivo móvil o de escritorio, garantizando la pervivencia y universalidad de los resultados del proyecto.

# Conclusiones y trabajo futuro



## Conclusiones
<!-- Revisión clara y concisa de los hallazgos más relevantes del estudio, vinculados directamente con los objetivos o hipótesis planteados. Reconocimiento honesto de los puntos débiles o restricciones (por ejemplo, tamaño de muestra reducido, falta de datos, sesgos.  Evitar aquí generalidades de ChatGPT --> 

Este estudio se planteó con el objetivo principal de determinar si la baja remuneración en Canarias y España obedecía a factores de intensidad laboral o a causas estructurales. Tras completar el ciclo de análisis de datos (ETL, Visualización y Modelado), se exponen los siguientes hallazgos vinculados a las hipótesis iniciales:  

#### Refutación de la Hipótesis del Esfuerzo (La Paradoja de la Eficiencia):  

Los datos son concluyentes al descartar la falta de intensidad laboral como causa de la pobreza relativa.  

- A nivel europeo, se ha demostrado una correlación inversa entre horas trabajadas y coste laboral (pendiente negativa con una alta correlación en la regresión lineal).  

- Específicamente en el caso de Canarias, la serie temporal (2000-2023) evidencia que la región mantiene un promedio de horas anuales por empleado sistemáticamente superior a la media de la UE. Por tanto, la brecha salarial no se justifica por un menor presencialismo.  

#### El Determinante Sectorial y la "Penalización del Talento": 

Se confirma que la estructura productiva es el factor causal de la desigualdad regional.

- El análisis de correlación y PCA agrupa matemáticamente a las regiones ricas (Madrid, País Vasco) con los vectores de Finanzas y TIC, y a las regiones rezagadas con Hostelería y Agricultura.  

- El hallazgo más crítico es la identificación de una "penalización insular del talento". La brecha salarial Canarias-Europa es mucho más profunda en sectores de alto valor añadido (Profesionales y Científicas, Información) que en sectores de servicios básicos. Esto indica que el modelo económico actual de las islas devalúa la cualificación técnica, incentivando la fuga de cerebros.  

#### Divergencia Económica (Desacople):

Contrario a las teorías de convergencia, los modelos predictivos (ARIMA) y el análisis de la brecha histórica muestran un desacople estructural. Tras las crisis de 2008 y 2020, la distancia entre los salarios canarios y la media nacional no se está cerrando, sino que se cronifica.

### Limitaciones del Estudio  

Para una correcta interpretación de estos resultados, es necesario reconocer las restricciones inherentes a los datos y la metodología empleada:  

- **Naturaleza del Indicador (Coste vs. Salario):** El estudio utiliza el Coste Laboral Total (que incluye cotizaciones sociales e impuestos a cargo del empleador) como proxy de riqueza. No se ha analizado el Salario Neto, por lo que las diferencias en la presión fiscal entre países podrían matizar la brecha de poder adquisitivo real de los trabajadores.  

- **Falta de Granularidad en Horas:** Eurostat no ofrece datos abiertos de Horas Trabajadas desglosados por sector específico para todas las regiones NUTS 2. Esto ha impedido calcular la eficiencia exacta (euros/hora) dentro de cada sector específico en Canarias, obligando a trabajar con promedios agregados regionales.  

- **Efecto de la Economía Sumergida:** Al basarse exclusivamente en fuentes oficiales (INE, Eurostat), el análisis no captura el impacto de la economía informal, que podría tener un peso desigual entre las distintas comunidades autónomas analizadas.  

## Trabajo futuro
<!-- Líneas de trabajo futuro, aspectos pendientes, posibles extensiones. --> 

Aunque este proyecto ha logrado diagnosticar con éxito las causas estructurales de la brecha salarial, el proceso de análisis ha revelado nuevas preguntas y limitaciones en los datos públicos que abren líneas interesantes para futuras investigaciones:

- **Del Coste Empleador al Bolsillo del Empleado:** Los indicadores utilizados en esta memoria reflejan el Coste Laboral (lo que paga la empresa, incluyendo cotizaciones e impuestos), no el salario neto que percibe el trabajador. Dado que la fiscalidad (la "cuña fiscal") varía enormemente entre países europeos, una extensión natural de este trabajo sería cruzar los datos de coste con la estructura impositiva de cada país. Esto permitiría analizar la brecha en términos de poder adquisitivo real, verificando si la diferencia de riqueza percibida por las familias es aún mayor que la sugerida por los costes empresariales.  

- **Perspectiva de Género:** La estructura sectorial tiene un fuerte impacto en la brecha de género, dado que existen sectores muy masculinizados (Industria) y feminizados (Cuidados/Servicios). Una evolución necesaria de este estudio sería desagregar los datos por sexo para determinar si la "trampa de bajo valor" en regiones como Canarias penaliza doblemente a las mujeres, o si la precariedad es transversal.  

- **Mayor Granularidad Sectorial:** La mayor limitación técnica encontrada ha sido la falta de disponibilidad en fuentes públicas (Eurostat) de las variables Horas Trabajadas y Coste por Persona Empleada desagregadas por sector. Actualmente, solo el Coste por Hora ofrece ese nivel de detalle. Un trabajo futuro debería enfocarse en integrar otras fuentes estadísticas (como la Encuesta de Población Activa - EPA - microdatos) para reconstruir estas métricas. Poder calcular las horas exactas que se trabajan en "Hostelería" frente a "Finanzas" permitiría afinar el modelo de eficiencia y entender mejor la carga laboral real de cada profesión.  


## Anexo. Seguimiento temporal actividades del proyecto  {-} 

Para la realización de este proyecto se ha llevado a cabo un registro detallado de la actividad, permitiendo cuantificar el coste temporal real de cada fase del ciclo de vida de los datos. Las siguientes visualizaciones desglosan el **total de horas invertidas**, su distribución semanal y, lo más relevante, la carga de trabajo por etapa (preparación, modelado, despliegue).

<!-- Lo primero que hay que hacer es compartir en modo lectura la hoja de cálculo Google Sheet que habremos descargado del Campus Virtual para registrar las sesiones de trabajo. A continuación se sustituirá, debajo, el enlace que figura en la lectura del archivo (read_sheet) por el enlace compartido que has creado. 

ES OBLIGATORIO TENER ACTUALIZADO ESTE APARTADO EN CADA ENTREGA DEL PROYECTO. 

CADA SESIÓN DE TRABAJO SE DEBE REGISTRAR EN LA GOOGLE SHEET EN EL MOMENTO DE REALIZARSE. EN PARTICULAR EN UNA ENTREGA  DEL PROYECTO NO PUEDEN APARECER SESIONES DE TRABAJOS NUEVAS CON FECHAS ANTERIORES A LA ENTREGA ANTERIOR DEL PROYECTO. 
-->

<!-- 
IMPORTANTE: La primera vez que ejecutes este chunk desde la consola de R se te pedirá gestionar una autorización para usar una cuenta Google. Es decir, en medio de la ejecución del chunk,  ve a la consola de R y ten en cuenta lo que se te pide. 
-->


```{r}
gs4_deauth() 
SeguimientoActividadesProyecto <- read_sheet('https://docs.google.com/spreadsheets/d/1W6VrcVWawxEk-b0zxrtVtOn-dtGl86BYEAWZ4qOYe0g/edit?usp=sharing') %>%
  as_tibble()

```

TOTAL HORAS TRABAJADAS EN EL PROYECTO : `r  round(sum(SeguimientoActividadesProyecto$MINUTES/60, na.rm=TRUE),digits=2)`


```{r, fig.width=9}
actividades <- c("Introducción","Aportaciones del trabajo","Compresión del negocio","Comprensión de los datos","Preparación de los datos","Modelado","Evaluación","Despliegue","Conclusiones y Trabajo Futuro","Otros")
p <- SeguimientoActividadesProyecto%>%
  group_by(ACTIVITY)%>%
   summarise(
     HORAS=round(sum(MINUTES)/60,digits = 1)
   )%>%
  mutate(ACTIVITY=factor(ACTIVITY,levels=actividades)) %>% 
  na.omit() %>% 
  ggplot(aes(ACTIVITY,HORAS)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=HORAS),size=3,colour = "blue",nudge_y = 0.2)+ 
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  labs(x="",y="HORAS TRABAJADAS",title = "TOTAL HORAS TRABAJADAS EN EL PROYECTO POR ACTIVIDAD")

ggplotly(p)

```

```{r,fig.width=9,cache=FALSE}
p <- SeguimientoActividadesProyecto%>%
  mutate(week=yearweek(as.Date(START))) %>% 
  group_by(week)%>%
   summarise(
     HORAS=round(sum(MINUTES)/60,digits = 1)
   )%>%
  ggplot(aes(week,HORAS)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=HORAS),size=3,colour = "blue",nudge_y = 0.2)+ 
  theme(axis.text.x = element_text(angle = 45,hjust=1))+
  labs(x="",y="HORAS TRABAJADAS",title = "TOTAL HORAS TRABAJADAS POR SEMANA")

ggplotly(p)
  
 
```

**DESGLOSE DETALLADO DE LAS SESIONES DE TRABAJO**
```{r}
SeguimientoActividadesProyecto%>% 
  datatable(
  options = list(
    scrollX = TRUE,   # Scroll horizontal
    scrollY = "400px", # Scroll vertical
    paging = FALSE     # Desactiva paginación si quieres solo scroll
  )
)

```
